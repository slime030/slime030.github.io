<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±ï¼ˆå¤šå¸³æˆ¶ï½œå°/ç¾è‚¡ï½œå®šå­˜ï½œé›²ç«¯åŒæ­¥ï¼‰</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Microsoft JhengHei',Arial,sans-serif}
    body{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);min-height:100vh;padding:20px}
    .container{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 40px rgba(0,0,0,.1);overflow:hidden}
    .header{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);padding:30px;text-align:center;color:#fff;position:relative}
    .header h1{font-size:2.2em;font-weight:600;margin-bottom:8px;letter-spacing:.5px}
    .header p{opacity:.9}
    .sync-status{position:absolute;top:20px;right:20px;padding:8px 15px;border-radius:20px;font-size:12px;font-weight:600;background:rgba(255,255,255,.2);backdrop-filter:blur(10px)}
    .sync-status.online{background:rgba(40,167,69,.8)}
    .sync-status.offline{background:rgba(220,53,69,.8)}
    .auth-section{background:rgba(255,255,255,.1);padding:15px;margin-top:15px;border-radius:10px;backdrop-filter:blur(10px)}
    .auth-form{display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:center}
    .auth-form input{padding:10px 12px;border:none;border-radius:8px;font-size:14px}
    .auth-form button{padding:10px 15px;border:none;border-radius:8px;background:rgba(255,255,255,.95);color:#333;cursor:pointer;font-weight:700}
    .tabs{position:sticky;top:0;z-index:50;display:flex;background:#f8f9fa;border-bottom:1px solid #e9ecef;flex-wrap:wrap}
    .tab{flex:1;min-width:120px;padding:14px 10px;background:none;border:none;cursor:pointer;font-size:14px;font-weight:600;transition:all .2s ease;border-bottom:3px solid transparent}
    .tab.active{background:#fff;border-bottom-color:#4facfe;color:#4facfe}
    .tab:hover{background:#eef2f7}
    .content{display:none;padding:26px}
    .content.active{display:block}
    .form-section{background:#f8f9fa;border-radius:15px;padding:22px;margin-bottom:24px;box-shadow:0 5px 15px rgba(0,0,0,.05)}
    .form-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:14px;margin-bottom:16px}
    .form-group{display:flex;flex-direction:column}
    .form-group label{font-weight:700;margin-bottom:6px;color:#2f3640}
    .form-group input,.form-group select,.form-group textarea{padding:12px;border:2px solid #e9ecef;border-radius:10px;font-size:14px;transition:border-color .2s ease;background:#fff}
    .form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:#4facfe}
    .btn{background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%);color:#fff;border:none;padding:13px 22px;border-radius:10px;font-size:15px;font-weight:800;cursor:pointer;transition:transform .15s ease;margin:5px}
    .btn:hover{transform:translateY(-1px);box-shadow:0 6px 16px rgba(79,172,254,.35)}
    .btn:disabled{opacity:.6;cursor:not-allowed;transform:none}
    .btn-danger{background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%)}
    .btn-exchange{background:linear-gradient(135deg,#ffa726 0%,#ff7043 100%)}
    .btn-sync{background:linear-gradient(135deg,#28a745 0%,#20c997 100%)}
    .btn-sell{background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%);padding:8px 15px;font-size:12px}
    .btn-neutral{background:#6c757d}
    .btn-light{background:#e9ecef;color:#333}
    .btn-chip{background:#eef2f7;color:#2f3640;border:none;padding:8px 10px;border-radius:8px;font-size:12px;cursor:pointer}
    .btn-chip:hover{opacity:.9}
    .table-container{background:#fff;border-radius:15px;overflow:hidden;box-shadow:0 5px 15px rgba(0,0,0,.05);margin-top:14px;overflow-x:auto}
    table{width:100%;border-collapse:collapse;min-width:900px}
    th{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:13px 10px;font-weight:800;text-align:center;font-size:13px}
    td{padding:11px 10px;text-align:center;border-bottom:1px solid #e9ecef;font-size:13px}
    tr:hover{background:#f8f9fa}
    .profit{color:#28a745;font-weight:800}
    .loss{color:#dc3545;font-weight:800}
    .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:16px;margin-bottom:22px}
    .stat-card{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 10px 25px rgba(102,126,234,.28)}
    .capital-card{background:linear-gradient(135deg,#2ecc71 0%,#27ae60 100%);color:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 10px 25px rgba(46,204,113,.28)}
    .stat-value{font-size:1.8em;font-weight:900;margin-bottom:6px}
    .stat-label{font-size:1em;opacity:.9}
    .delete-btn{background:#dc3545;color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;font-size:12px}
    .delete-btn:hover{background:#c82333}
    .fee-info{background:#e8f4fd;padding:12px;border-radius:10px;margin-bottom:12px;border-left:4px solid #4facfe;text-align:left}
    .fee-info h4{color:#0066cc;margin-bottom:6px}
    .fee-info p{margin:2px 0;color:#495057}
    .market-indicator{display:inline-block;padding:3px 8px;border-radius:12px;font-size:11px;font-weight:800;color:#fff}
    .market-tw{background:#28a745}.market-us{background:#007bff}
    .exchange-card{background:linear-gradient(135deg,#ffa726 0%,#ff7043 100%);color:#fff;padding:20px;border-radius:15px;text-align:center;box-shadow:0 10px 25px rgba(255,167,38,.28)}
    .loading{display:inline-block;width:20px;height:20px;border:3px solid rgba(255,255,255,.3);border-radius:50%;border-top-color:#fff;animation:spin 1s ease-in-out infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    .notification{position:fixed;top:20px;right:20px;padding:14px 16px;border-radius:10px;color:#fff;font-weight:800;z-index:1000;transform:translateX(100%);transition:transform .25s ease}
    .notification.show{transform:translateX(0)}
    .notification.success{background:#28a745}.notification.error{background:#dc3545}
    .modal{display:none;position:fixed;z-index:2000;left:0;top:0;width:100%;height:100%;background-color:rgba(0,0,0,.5)}
    .modal-content{background:#fff;margin:5% auto;padding:24px;border-radius:15px;width:90%;max-width:520px;box-shadow:0 20px 40px rgba(0,0,0,.3)}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;padding-bottom:12px;border-bottom:1px solid #e9ecef}
    .modal-header h3{color:#495057}.close{color:#aaa;font-size:26px;font-weight:900;cursor:pointer}.close:hover{color:#333}
    .account-switcher{margin-top:12px;display:flex;flex-direction:column;align-items:center;gap:6px}
    .account-row{display:flex;gap:8px;flex-wrap:wrap;justify-content:center}
    #accountSelect{padding:8px 12px;border-radius:8px;border:2px solid #e9ecef;font-size:14px;background:#fff}
    .btn-sm{padding:8px 12px;font-size:12px;border-radius:8px;border:none;cursor:pointer}.btn-sm:hover{opacity:.9}
    .input-with-btn{display:flex;gap:8px;align-items:center}
    .hint{color:#555;margin-top:6px;min-height:18px;display:block;font-size:12px;text-align:left}
    .api-status{margin-top:10px;padding:8px 12px;border-radius:8px;font-size:12px;font-weight:600}
    .api-status.success{background:#d4edda;color:#155724}.api-status.warning{background:#fff3cd;color:#856404}.api-status.error{background:#f8d7da;color:#721c24}
    @media(max-width:768px){.container{margin:10px;border-radius:10px}.header{padding:20px}.header h1{font-size:1.6em}.content{padding:18px}.form-grid{grid-template-columns:1fr}.stats-grid{grid-template-columns:1fr}table{font-size:12px}th,td{padding:8px 5px}.tab{font-size:12px;padding:12px 8px}.sync-status{position:static;display:inline-block;margin-top:10px}.auth-form{flex-direction:column;align-items:stretch}.auth-form input,.auth-form button{width:100%;margin:5px 0}.modal-content{margin:10% auto;width:95%;padding:20px}}
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="sync-status" id="syncStatus">
        <span class="loading" id="loadingSpinner" style="display:none;"></span>
        <span id="statusText">é›¢ç·šæ¨¡å¼</span>
      </div>
      <h1>ğŸ“ˆ è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</h1>
      <p>å¤šå¸³æˆ¶ï½œå°/ç¾è‚¡è¨˜éŒ„èˆ‡ç¸¾æ•ˆåˆ†æï½œå®šå­˜ç³»çµ±ï½œé›²ç«¯åŒæ­¥</p>

      <div class="auth-section" id="authSection">
        <div class="auth-form">
          <input type="email" id="userEmail" placeholder="é›»å­éƒµä»¶">
          <input type="password" id="userPassword" placeholder="å¯†ç¢¼">
          <button onclick="signIn()">ç™»å…¥</button>
          <button onclick="signUp()">è¨»å†Š</button>
          <button onclick="signOut()" id="signOutBtn" style="display:none;">ç™»å‡º</button>
        </div>
        <p style="font-size:12px; margin-top:10px; opacity:.85;">å·²å…§å»º Firebase èˆ‡ Finnhub è¨­å®šï¼Œå¯ç›´æ¥ä½¿ç”¨ï¼ˆå¯æ–¼ã€Œè¨­å®šã€é ä¿®æ”¹ï¼‰</p>
        <div id="firebaseStatus" class="api-status success">Firebase: å°šæœªåˆå§‹åŒ–</div>
      </div>

      <div class="account-switcher">
        <div class="account-row">
          <select id="accountSelect" onchange="onAccountChange(this.value)"></select>
          <button class="btn-sm btn-light" onclick="createAccount()">æ–°å¢å¸³æˆ¶</button>
          <button class="btn-sm btn-light" onclick="renameAccount()">é‡æ–°å‘½å</button>
          <button class="btn-sm btn-danger" onclick="removeAccount()">åˆªé™¤å¸³æˆ¶</button>
        </div>
        <small id="accountMeta" style="opacity:.85;"></small>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('transaction')">äº¤æ˜“ç´€éŒ„</button>
      <button class="tab" onclick="switchTab('exchange')">æ›åŒ¯ç´€éŒ„</button>
      <button class="tab" onclick="switchTab('portfolio')">æŒå€‰æ˜ç´°</button>
      <button class="tab" onclick="switchTab('capital')">è³‡æœ¬ç®¡ç†</button>
      <button class="tab" onclick="switchTab('deposits')">å®šå­˜ç³»çµ±</button>
      <button class="tab" onclick="switchTab('analysis')">ç¸¾æ•ˆåˆ†æ</button>
      <button class="tab" onclick="switchTab('settings')">è¨­å®š</button>
      <button class="tab" onclick="switchTab('export')">åŒ¯å‡º/åŒ¯å…¥</button>
    </div>

    <!-- äº¤æ˜“ç´€éŒ„ -->
    <div id="transaction" class="content active">
      <div class="fee-info">
        <h4>ğŸ’¡ æ‰‹çºŒè²»è‡ªå‹•è¨ˆç®—èªªæ˜</h4>
        <p><strong>å°è‚¡ï¼š</strong>æ‰‹çºŒè²» 0.1425%ï¼Œæ•´è‚¡æœ€ä½20å…ƒï¼Œé›¶è‚¡æœ€ä½1å…ƒï½œäº¤æ˜“ç¨…ï¼ˆè³£å‡ºï¼‰0.3%</p>
        <p><strong>ç¾è‚¡ï¼š</strong>ä¾åˆ¸å•†è¨­å®šè¨ˆç®—ï¼Œå¯åœ¨ã€Œè¨­å®šã€ä¸­èª¿æ•´</p>
        <button class="btn btn-sync" onclick="syncData()" id="syncBtn" disabled>
          <span id="syncBtnText">ğŸ”„ åŒæ­¥è³‡æ–™</span>
        </button>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ“ æ–°å¢äº¤æ˜“ç´€éŒ„</h3>
        <form id="transactionForm">
          <div class="form-grid">
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="date" required></div>
            <div class="form-group">
              <label>å¸‚å ´</label>
              <select id="market" required>
                <option value="">é¸æ“‡å¸‚å ´</option>
                <option value="TW">å°è‚¡ ğŸ‡¹ğŸ‡¼</option>
                <option value="US">ç¾è‚¡ ğŸ‡ºğŸ‡¸</option>
              </select>
            </div>
            <div class="form-group">
              <label>è‚¡ç¥¨ä»£è™Ÿ</label>
              <div class="input-with-btn">
                <input type="text" id="symbol" placeholder="ä¾‹: 2330, AAPL" required>
                <button type="button" class="btn-chip" onclick="peekQuote()">ğŸ” æŸ¥åƒ¹</button>
              </div>
              <small id="lastQuoteHint" class="hint"></small>
            </div>
            <div class="form-group"><label>è‚¡ç¥¨åç¨±</label><input type="text" id="name" placeholder="ä¾‹: å°ç©é›», Apple Inc." required></div>
            <div class="form-group">
              <label>äº¤æ˜“é¡å‹</label>
              <select id="type" required>
                <option value="">é¸æ“‡é¡å‹</option>
                <option value="è²·é€²">è²·é€²</option>
                <option value="è³£å‡º">è³£å‡º</option>
              </select>
            </div>
            <div class="form-group"><label>æ•¸é‡</label><input type="number" id="quantity" placeholder="è‚¡æ•¸" required></div>
            <div class="form-group">
              <label>åƒ¹æ ¼</label>
              <div class="input-with-btn">
                <input type="number" id="price" step="0.01" placeholder="æ¯è‚¡åƒ¹æ ¼" required>
                <button type="button" class="btn-chip" onclick="fillCurrentPrice()">â†˜ ç¾åƒ¹å¡«å…¥</button>
              </div>
            </div>
            <div class="form-group">
              <label>æ˜¯å¦ç‚ºé›¶è‚¡ (å°è‚¡)</label>
              <select id="oddLot">
                <option value="false">æ•´è‚¡äº¤æ˜“</option>
                <option value="true">é›¶è‚¡äº¤æ˜“</option>
              </select>
            </div>
            <div class="form-group"><label>æ‰‹çºŒè²»</label><input type="number" id="fee" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly></div>
            <div class="form-group"><label>äº¤æ˜“ç¨…</label><input type="number" id="tax" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="note" placeholder="é¸å¡«"></div>
          </div>
          <button type="button" onclick="calculateFees()" class="btn btn-neutral">ğŸ§® é‡æ–°è¨ˆç®—è²»ç”¨</button>
          <button type="submit" class="btn">â• æ–°å¢äº¤æ˜“</button>
        </form>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>å¸‚å ´</th><th>ä»£è™Ÿ</th><th>åç¨±</th>
            <th>é¡å‹</th><th>æ•¸é‡</th><th>åƒ¹æ ¼</th><th>é›¶è‚¡</th>
            <th>æ‰‹çºŒè²»</th><th>äº¤æ˜“ç¨…</th><th>ç¸½é‡‘é¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="transactionTable"></tbody>
        </table>
      </div>
    </div>

    <!-- æ›åŒ¯ç´€éŒ„ -->
    <div id="exchange" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ’± æ–°å¢æ›åŒ¯ç´€éŒ„</h3>
        <form id="exchangeForm">
          <div class="form-grid">
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="exchangeDate" required></div>
            <div class="form-group">
              <label>å…Œæ›é¡å‹</label>
              <select id="exchangeType" required>
                <option value="">é¸æ“‡å…Œæ›</option>
                <option value="TWD-USD">å°å¹£ â†’ ç¾å…ƒ</option>
                <option value="USD-TWD">ç¾å…ƒ â†’ å°å¹£</option>
                <option value="TWD-CNY">å°å¹£ â†’ äººæ°‘å¹£</option>
                <option value="CNY-TWD">äººæ°‘å¹£ â†’ å°å¹£</option>
                <option value="USD-CNY">ç¾å…ƒ â†’ äººæ°‘å¹£</option>
                <option value="CNY-USD">äººæ°‘å¹£ â†’ ç¾å…ƒ</option>
              </select>
            </div>
            <div class="form-group"><label>å…Œå‡ºé‡‘é¡</label><input type="number" id="fromAmount" step="0.01" required></div>
            <div class="form-group"><label>åŒ¯ç‡</label><input type="number" id="exchangeRate" step="0.0001" required></div>
            <div class="form-group">
              <label>å…Œå…¥é‡‘é¡</label>
              <div class="input-with-btn">
                <input type="number" id="toAmount" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
                <button type="button" class="btn-chip" onclick="calculateExchangeAmount()">â†» è¨ˆç®—</button>
              </div>
            </div>
            <div class="form-group"><label>æ‰‹çºŒè²»</label><input type="number" id="exchangeFee" step="0.01" value="0"></div>
            <div class="form-group"><label>éŠ€è¡Œ/åˆ¸å•†</label><input type="text" id="exchangeBank" placeholder="ä¾‹: å°éŠ€, å¯Œé‚¦"></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="exchangeNote" placeholder="é¸å¡«"></div>
          </div>
          <button type="submit" class="btn btn-exchange">ğŸ’± æ–°å¢æ›åŒ¯ç´€éŒ„</button>
        </form>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>å…Œæ›é¡å‹</th><th>å…Œå‡ºé‡‘é¡</th><th>åŒ¯ç‡</th><th>å…Œå…¥é‡‘é¡</th>
            <th>æ‰‹çºŒè²»</th><th>éŠ€è¡Œ/åˆ¸å•†</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="exchangeTable"></tbody>
        </table>
      </div>
    </div>

    <!-- æŒå€‰æ˜ç´° -->
    <div id="portfolio" class="content">
      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>å¸‚å ´</th><th>ä»£è™Ÿ</th><th>åç¨±</th><th>æŒæœ‰è‚¡æ•¸</th>
            <th>å¹³å‡æˆæœ¬</th><th>ç¸½æˆæœ¬</th><th>ç¾åƒ¹</th><th>å¸‚å€¼</th>
            <th>æœªå¯¦ç¾æç›Š</th><th>å ±é…¬ç‡(%)</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="portfolioTable"></tbody>
        </table>
      </div>
    </div>

    <!-- è³‡æœ¬ç®¡ç† -->
    <div id="capital" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ’° è³‡æœ¬ç®¡ç†</h3>
        <form id="capitalForm">
          <div class="form-grid">
            <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="capitalDate" required></div>
            <div class="form-group">
              <label>é¡å‹</label>
              <select id="capitalType" required>
                <option value="">é¸æ“‡é¡å‹</option>
                <option value="åˆå§‹æŠ•å…¥">åˆå§‹æŠ•å…¥</option>
                <option value="è¿½åŠ æŠ•å…¥">è¿½åŠ æŠ•å…¥</option>
                <option value="è³‡é‡‘æå–">è³‡é‡‘æå–</option>
              </select>
            </div>
            <div class="form-group"><label>é‡‘é¡</label><input type="number" id="capitalAmount" step="0.01" required></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="capitalNote" placeholder="é¸å¡«"></div>
          </div>
          <button type="submit" class="btn">ğŸ’° æ–°å¢è³‡æœ¬ç´€éŒ„</button>
        </form>
      </div>

      <div class="stats-grid">
        <div class="capital-card"><div class="stat-value" id="totalCapital">$0</div><div class="stat-label">ç¸½æŠ•å…¥è³‡æœ¬</div></div>
        <div class="capital-card"><div class="stat-value" id="availableCapital">$0</div><div class="stat-label">å¯ç”¨è³‡é‡‘</div></div>
        <div class="capital-card"><div class="stat-value" id="investedCapital">$0</div><div class="stat-label">å·²æŠ•è³‡é‡‘é¡</div></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr><th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>ç´¯è¨ˆè³‡æœ¬</th><th>å‚™è¨»</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="capitalTable"></tbody>
        </table>
      </div>
    </div>

    <!-- å®šå­˜ç³»çµ± -->
    <div id="deposits" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ¦ æ–°å¢å®šå­˜è¨˜éŒ„</h3>
        <form id="depositForm">
          <div class="form-grid">
            <div class="form-group"><label>é–‹å§‹æ—¥æœŸ</label><input type="date" id="depositStartDate" required></div>
            <div class="form-group"><label>åˆ°æœŸæ—¥æœŸ</label><input type="date" id="depositEndDate" required></div>
            <div class="form-group"><label>éŠ€è¡Œåç¨±</label><input type="text" id="depositBank" placeholder="ä¾‹ï¼šå°ç£éŠ€è¡Œã€å¯Œé‚¦éŠ€è¡Œ" required></div>
            <div class="form-group">
              <label>å®šå­˜é¡å‹</label>
              <select id="depositType" required>
                <option value="">é¸æ“‡é¡å‹</option>
                <option value="å®šæœŸå­˜æ¬¾">å®šæœŸå­˜æ¬¾</option>
                <option value="å®šæœŸå„²è“„å­˜æ¬¾">å®šæœŸå„²è“„å­˜æ¬¾</option>
                <option value="å¤–å¹£å®šå­˜">å¤–å¹£å®šå­˜</option>
                <option value="æ•¸ä½å¸³æˆ¶">æ•¸ä½å¸³æˆ¶é«˜åˆ©å®šå­˜</option>
                <option value="å¤§é¡å®šå­˜">å¤§é¡å®šå­˜</option>
              </select>
            </div>
            <div class="form-group">
              <label>å¹£åˆ¥</label>
              <select id="depositCurrency" required>
                <option value="TWD">å°å¹£ (TWD)</option>
                <option value="USD">ç¾å…ƒ (USD)</option>
                <option value="CNY">äººæ°‘å¹£ (CNY)</option>
                <option value="JPY">æ—¥åœ“ (JPY)</option>
                <option value="EUR">æ­å…ƒ (EUR)</option>
                <option value="AUD">æ¾³å¹£ (AUD)</option>
                <option value="NZD">ç´å¹£ (NZD)</option>
              </select>
            </div>
            <div class="form-group"><label>æœ¬é‡‘</label><input type="number" id="depositPrincipal" step="0.01" required></div>
            <div class="form-group"><label>å¹´åˆ©ç‡ (%)</label><input type="number" id="depositRate" step="0.01" placeholder="ä¾‹ï¼š1.35" required></div>
            <div class="form-group"><label>å­˜æœŸ (æœˆ)</label><input type="number" id="depositTerm" placeholder="è‡ªå‹•è¨ˆç®—" readonly></div>
            <div class="form-group">
              <label>è¨ˆæ¯æ–¹å¼</label>
              <select id="depositInterestType">
                <option value="simple">å–®åˆ©</option>
                <option value="compound">è¤‡åˆ© (æœˆè¤‡åˆ©)</option>
              </select>
            </div>
            <div class="form-group"><label>é è¨ˆåˆ©æ¯</label><input type="number" id="depositInterest" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly></div>
            <div class="form-group"><label>åˆ°æœŸæœ¬æ¯</label><input type="number" id="depositMaturityAmount" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly></div>
            <div class="form-group"><label>å‚™è¨»</label><input type="text" id="depositNote" placeholder="é¸å¡«"></div>
          </div>
          <button type="button" onclick="calculateDepositInterest()" class="btn btn-neutral">ğŸ§® è¨ˆç®—åˆ©æ¯</button>
          <button type="submit" class="btn">ğŸ¦ æ–°å¢å®šå­˜</button>
        </form>
      </div>

      <div class="stats-grid">
        <div class="capital-card"><div class="stat-value" id="totalDepositPrincipal">$0</div><div class="stat-label">å®šå­˜æœ¬é‡‘ç¸½é¡</div></div>
        <div class="capital-card"><div class="stat-value" id="totalDepositInterest">$0</div><div class="stat-label">é è¨ˆåˆ©æ¯æ”¶å…¥</div></div>
        <div class="capital-card"><div class="stat-value" id="activeDepositsCount">0</div><div class="stat-label">æ´»èºå®šå­˜ç­†æ•¸</div></div>
        <div class="capital-card"><div class="stat-value" id="avgDepositRate">0%</div><div class="stat-label">å¹³å‡å¹´åˆ©ç‡</div></div>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>éŠ€è¡Œ</th><th>é¡å‹</th><th>å¹£åˆ¥</th><th>æœ¬é‡‘</th>
            <th>å¹´åˆ©ç‡</th><th>å­˜æœŸ</th><th>é–‹å§‹æ—¥æœŸ</th><th>åˆ°æœŸæ—¥æœŸ</th>
            <th>é è¨ˆåˆ©æ¯</th><th>åˆ°æœŸæœ¬æ¯</th><th>ç‹€æ…‹</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="depositTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ç¸¾æ•ˆåˆ†æ -->
    <div id="analysis" class="content">
      <div class="stats-grid">
        <div class="stat-card"><div class="stat-value" id="totalInvestment">$0</div><div class="stat-label">ç¸½æŠ•å…¥é‡‘é¡</div></div>
        <div class="stat-card"><div class="stat-value" id="totalValue">$0</div><div class="stat-label">ç¸½å¸‚å€¼</div></div>
        <div class="stat-card"><div class="stat-value" id="totalProfit">$0</div><div class="stat-label">ç¸½æç›Š</div></div>
        <div class="stat-card"><div class="stat-value" id="totalReturn">0%</div><div class="stat-label">ç¸½å ±é…¬ç‡</div></div>
        <div class="exchange-card"><div class="stat-value" id="totalExchangeFee">$0</div><div class="stat-label">ç¸½æ›åŒ¯è²»ç”¨</div></div>
        <div class="stat-card"><div class="stat-value" id="realizedProfitTotal">$0</div><div class="stat-label">å·²å¯¦ç¾æç›Šï¼ˆè‚¡ï¼‰</div></div>
        <div class="stat-card"><div class="stat-value" id="fxProfitTotal">$0</div><div class="stat-label">æ›åŒ¯æç›Šï¼ˆTWDï¼‰</div></div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ’µ å€‹è‚¡è³£å‡ºæç›Š</h3>
        <div class="table-container">
          <table>
            <thead>
            <tr>
              <th>æ—¥æœŸ</th><th>å¸‚å ´</th><th>ä»£è™Ÿ</th><th>åç¨±</th>
              <th>è³£å‡ºè‚¡æ•¸</th><th>å¹³å‡æˆæœ¬</th><th>è³£å‡ºæ·¨é¡</th>
              <th>æˆæœ¬</th><th>å·²å¯¦ç¾æç›Š</th><th>å ±é…¬ç‡(%)</th><th>å‚™è¨»</th>
            </tr>
            </thead>
            <tbody id="realizedTable"></tbody>
          </table>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ’± æ›åŒ¯æç›Š</h3>
        <div class="table-container">
          <table>
            <thead>
            <tr>
              <th>æ—¥æœŸ</th><th>å¹£åˆ¥å°</th><th>å‹•ä½œ</th><th>æ•¸é‡</th>
              <th>åŒ¯ç‡</th><th>è²»ç”¨(TWD)</th><th>å·²å¯¦ç¾æç›Š(TWD)</th><th>å‚™è¨»</th>
            </tr>
            </thead>
            <tbody id="fxPnLTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div id="settings" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">âš™ï¸ äº¤æ˜“è²»ç‡è¨­å®š</h3>
        <h4 style="color:#28a745;margin-bottom:10px;">ğŸ‡¹ğŸ‡¼ å°è‚¡è²»ç‡è¨­å®š</h4>
        <div class="form-grid">
          <div class="form-group"><label>æ‰‹çºŒè²»ç‡ (%)</label><input type="number" id="twFeeRate" step="0.0001" value="0.1425"></div>
          <div class="form-group"><label>æ•´è‚¡æœ€ä½æ‰‹çºŒè²»</label><input type="number" id="twMinFee" step="1" value="20"></div>
          <div class="form-group"><label>é›¶è‚¡æœ€ä½æ‰‹çºŒè²»</label><input type="number" id="twOddLotMinFee" step="1" value="1"></div>
          <div class="form-group"><label>è­‰äº¤ç¨…ç‡ï¼ˆè³£å‡ºï¼‰%</label><input type="number" id="twTaxRate" step="0.01" value="0.3"></div>
        </div>

        <h4 style="color:#007bff;margin:10px 0;">ğŸ‡ºğŸ‡¸ ç¾è‚¡è²»ç‡è¨­å®š</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>æ‰‹çºŒè²»é¡å‹</label>
            <select id="usFeeType"><option value="fixed">å›ºå®šé‡‘é¡</option><option value="rate">ç™¾åˆ†æ¯”</option></select>
          </div>
          <div class="form-group"><label>å›ºå®šæ‰‹çºŒè²»</label><input type="number" id="usFixedFee" step="0.01" value="0"></div>
          <div class="form-group"><label>æ‰‹çºŒè²»ç‡ (%)</label><input type="number" id="usFeeRate" step="0.0001" value="0"></div>
          <div class="form-group"><label>æœ€ä½æ‰‹çºŒè²»</label><input type="number" id="usMinFee" step="0.01" value="0"></div>
        </div>
        <button class="btn" onclick="saveFeeSettings()">ğŸ’¾ å„²å­˜è²»ç‡è¨­å®š</button>
        <button class="btn btn-danger" onclick="resetFeeSettings()">â†©ï¸ é‡ç½®ç‚ºé è¨­</button>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ“¡ å ±åƒ¹è¨­å®šï¼ˆå°è‚¡ TWSEï¼›ç¾è‚¡ Finnhubï¼‰</h3>
        <div id="priceApiStatus" class="api-status success">APIç‹€æ…‹ï¼šæœªæ¸¬è©¦</div>
        <div class="form-grid">
          <div class="form-group">
            <label>ä½¿ç”¨å³æ™‚å ±åƒ¹</label>
            <select id="useLivePrice"><option value="true">æ˜¯ï¼ˆé è¨­é–‹å•Ÿï¼‰</option><option value="false">å¦</option></select>
          </div>
          <div class="form-group"><label>Finnhub API Key (ç¾è‚¡)</label><input type="text" id="finnhubKey" placeholder="ç¾è‚¡æŸ¥åƒ¹APIé‡‘é‘°"></div>
        </div>
        <small style="display:block;margin:6px 0;color:#555;">
          <strong>å°è‚¡ï¼š</strong>ä½¿ç”¨ TWSE å³æ™‚ä»‹é¢ (ç„¡éœ€é‡‘é‘°)<br>
          <strong>ç¾è‚¡ï¼š</strong>ä½¿ç”¨ Finnhub /quoteï¼ˆcï¼‰ï¼Œå·²å…§å»ºé è¨­é‡‘é‘°
        </small>
        <button class="btn" onclick="saveAppSettings()">ğŸ’¾ å„²å­˜å ±åƒ¹è¨­å®š</button>
        <button class="btn btn-neutral" onclick="testApiConnection()">ğŸ” æ¸¬è©¦APIé€£ç·š</button>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">â˜ï¸ Firebase é›²ç«¯åŒæ­¥è¨­å®š</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Firebase Config (JSON)</label>
            <textarea id="firebaseConfig" rows="6" placeholder='{"apiKey":"...","authDomain":"...","databaseURL":"...","projectId":"..."}'></textarea>
          </div>
        </div>
        <small style="display:block;margin:6px 0;color:#555;">å·²é è¨­ Firebase é…ç½®ï¼Œå¦‚éœ€è‡ªå®šç¾©å¯ä¿®æ”¹ä¸Šæ–¹ JSON å¾Œé‡æ–°åˆå§‹åŒ–</small>
        <button class="btn" onclick="saveFirebaseConfig()">ğŸ’¾ å„²å­˜Firebaseè¨­å®š</button>
        <button class="btn btn-neutral" onclick="initializeFirebase()">ğŸ”„ é‡æ–°åˆå§‹åŒ–</button>
      </div>
    </div>

    <!-- åŒ¯å‡º/åŒ¯å…¥ -->
    <div id="export" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ“¤ åŒ¯å‡º</h3>
        <div class="account-row" style="justify-content:flex-start;">
          <button class="btn btn-light" onclick="exportToCSV('transactions')">åŒ¯å‡ºäº¤æ˜“ç´€éŒ„ CSV</button>
          <button class="btn btn-light" onclick="exportToCSV('exchange')">åŒ¯å‡ºæ›åŒ¯ç´€éŒ„ CSV</button>
          <button class="btn btn-light" onclick="exportToCSV('capital')">åŒ¯å‡ºè³‡æœ¬ç´€éŒ„ CSV</button>
          <button class="btn btn-light" onclick="exportToCSV('deposits')">åŒ¯å‡ºå®šå­˜ç´€éŒ„ CSV</button>
          <button class="btn" onclick="exportAllData()">ğŸ’¾ åŒ¯å‡ºå®Œæ•´å‚™ä»½ï¼ˆJSONï¼‰</button>
          <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px;color:#495057;">ğŸ“¥ åŒ¯å…¥</h3>
        <div class="form-group">
          <label>åŒ¯å…¥å‚™ä»½æª”æ¡ˆ (JSON)</label>
          <input type="file" id="importFile" accept=".json" onchange="importData(this)">
        </div>
        <small style="display:block;margin:6px 0;color:#555;">æ”¯æ´åŒ¯å…¥æœ¬ç³»çµ±åŒ¯å‡ºçš„ JSON å‚™ä»½æª”æ¡ˆ</small>
      </div>
    </div>
  </div>

  <!-- å¿«é€Ÿè³£å‡º Modal -->
  <div id="sellModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>å¿«é€Ÿè³£å‡º</h3>
        <span class="close" onclick="closeSellModal()">&times;</span>
      </div>
      <form id="sellForm">
        <div class="form-grid">
          <div class="form-group"><label>è‚¡ç¥¨</label><input type="text" id="sellStockInfo" readonly></div>
          <div class="form-group"><label>å¯è³£è‚¡æ•¸</label><input type="number" id="sellAvailableQuantity" readonly></div>
          <div class="form-group"><label>è³£å‡ºè‚¡æ•¸</label><input type="number" id="sellQuantity" required min="1"></div>
          <div class="form-group"><label>è³£å‡ºåƒ¹æ ¼</label><input type="number" id="sellPrice" step="0.01" required></div>
          <div class="form-group"><label>æ—¥æœŸ</label><input type="date" id="sellDate" required></div>
          <div class="form-group"><label>å‚™è¨»</label><input type="text" id="sellNote" placeholder="é¸å¡«"></div>
        </div>
        <div style="text-align:right;">
          <button type="button" class="btn btn-light" onclick="closeSellModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-sell">ğŸ’¸ ç¢ºèªè³£å‡º</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // =========================
    // å…¨åŸŸç‹€æ…‹
    // =========================
    let transactions = [];
    let exchanges = [];
    let capitalRecords = [];
    let deposits = [];
    let feeSettings = {
      tw: { feeRate: 0.1425, minFee: 20, oddLotMinFee: 1, taxRate: 0.3 },
      us: { feeType: 'fixed', fixedFee: 0, feeRate: 0, minFee: 0 }
    };
    let currentPrices = {}; // { "TW-2330": {value, name, _ts} }
    let currentSellStock = null;
    let lastPeekPrice = null;

    // å¤šå¸³æˆ¶
    let accounts = {};
    let currentAccountId = null;
    const _genAccId = () => 'acc_' + Math.random().toString(36).slice(2,10);

    // å ±åƒ¹è¨­å®šï¼ˆå«é è¨­ Finnhub é‡‘é‘°ï¼‰
    let appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}') || {};
    if (appSettings.useLivePrice === undefined) appSettings.useLivePrice = true;
    if (!appSettings.finnhubKey) appSettings.finnhubKey = 'd30rabhr01qnu2qvafv0d30rabhr01qnu2qvafvg';

    // Firebase é è¨­é…ç½®ï¼ˆå¯æ–¼è¨­å®šé è¦†å¯«ï¼‰
    let firebaseConfig = {
      apiKey: "AIzaSyAFxgqpcgcA2LYL6OkoAmKobHTeqDFCRUY",
      authDomain: "stock-portfolio-app-d069f.firebaseapp.com",
      databaseURL: "https://stock-portfolio-app-d069f-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "stock-portfolio-app-d069f",
      storageBucket: "stock-portfolio-app-d069f.firebasestorage.app",
      messagingSenderId: "22049816403",
      appId: "1:22049816403:web:1d1023c91e855f20daeba6",
      measurementId: "G-2T6QWCPE2J"
    };
    const savedCfg = localStorage.getItem('firebaseConfig');
    if (savedCfg) { try { firebaseConfig = JSON.parse(savedCfg); } catch(e){} }

    // =========================
    // Firebase ç›¸å®¹å±¤ï¼ˆä¿®å¾© v9 æ¨¡çµ„ / compat å·®ç•°ï¼‰
    // =========================
    const FB = {
      ready:false, _auth:null, _db:null,
      init(){
        try{
          if (window.firebase && firebaseConfig) {
            if (!firebase.apps || !firebase.apps.length) firebase.initializeApp(firebaseConfig);
            this._auth = firebase.auth();
            this._db   = firebase.database();
            this.ready = true;
            updateFirebaseStatus('Firebase: å·²åˆå§‹åŒ–', 'success');
          } else {
            this.ready = false;
            updateFirebaseStatus('Firebase: SDK æœªè¼‰å…¥', 'error');
          }
        }catch(e){
          this.ready = false;
          updateFirebaseStatus('Firebase: åˆå§‹åŒ–å¤±æ•—', 'error');
          console.error('Firebase init error:', e);
        }
      },
      currentUser(){ return this._auth && this._auth.currentUser ? this._auth.currentUser : null },
      async createUser(email,pw){ if(!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–'); return this._auth.createUserWithEmailAndPassword(email,pw) },
      async signIn(email,pw){ if(!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–'); return this._auth.signInWithEmailAndPassword(email,pw) },
      async signOut(){ if(!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–'); return this._auth.signOut() },
      onAuth(cb){ if(this.ready) this._auth.onAuthStateChanged(cb) },
      async set(path,data){ if(!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–'); return this._db.ref(path).set(data) },
      async get(path){ if(!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–'); const snap = await this._db.ref(path).once('value'); return { exists:()=>snap.exists(), val:()=>snap.val() } }
    };
    function updateFirebaseStatus(text,type){ const el = document.getElementById('firebaseStatus'); if(el){ el.textContent=text; el.className = `api-status ${type}`; } }

    // =========================
    // UI è¼”åŠ©
    // =========================
    function updateSyncStatus(text,isOnline){
      const statusEl = document.getElementById('syncStatus');
      const statusText = document.getElementById('statusText');
      statusText.textContent = text;
      statusEl.className = `sync-status ${isOnline ? 'online':'offline'}`;
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) signOutBtn.style.display = isOnline ? 'inline-block' : 'none';
      const syncBtn = document.getElementById('syncBtn');
      if (syncBtn) syncBtn.disabled = !isOnline;
    }
    function showLoading(show){
      const spinner = document.getElementById('loadingSpinner');
      const syncBtn = document.getElementById('syncBtnText');
      if (show){ spinner.style.display='inline-block'; syncBtn.textContent='åŒæ­¥ä¸­...'; }
      else { spinner.style.display='none'; syncBtn.textContent='ğŸ”„ åŒæ­¥è³‡æ–™'; }
    }
    function showNotification(message,type){
      const n = document.createElement('div'); n.className=`notification ${type}`; n.textContent=message; document.body.appendChild(n);
      setTimeout(()=>n.classList.add('show'),60);
      setTimeout(()=>{ n.classList.remove('show'); setTimeout(()=>document.body.removeChild(n),300); },3000);
    }
    function switchTab(tabName){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c=>c.classList.remove('active'));
      const btn = document.querySelector(`.tabs .tab[onclick="switchTab('${tabName}')"]`);
      if (btn) btn.classList.add('active');
      const content = document.getElementById(tabName);
      if (content) content.classList.add('active');
      // åˆ‡æ›æ™‚æ›´æ–°å°æ‡‰æ•¸æ“š
      if (tabName==='portfolio') updatePortfolio();
      if (tabName==='analysis') updateAnalysis();
      if (tabName==='exchange') updateExchangeTable();
      if (tabName==='capital') updateCapitalTable();
      if (tabName==='deposits') { updateDepositTable(); updateDepositStats(); }
      if (tabName==='settings') { loadFeeSettings(); loadAppSettingsUI(); }
    }
    function setDefaultDates(){
      const today = new Date().toISOString().split('T')[0];
      ['date','exchangeDate','capitalDate','sellDate','depositStartDate','depositEndDate'].forEach(id=>{
        const el = document.getElementById(id); if (el) el.value = today;
      });
    }

    // =========================
    // å¤šå¸³æˆ¶æ ¸å¿ƒ
    // =========================
    function createEmptyAccount(name='é è¨­å¸³æˆ¶', type='ç¾è‚¡', baseCurrency='TWD'){
      return {
        id:_genAccId(), name, type, baseCurrency,
        transactions:[], exchanges:[], capitalRecords:[], deposits:[],
        feeSettings: JSON.parse(JSON.stringify(feeSettings)),
        createdAt: new Date().toISOString()
      };
    }
    function hydrateFromAccount(){
      if (!currentAccountId || !accounts[currentAccountId]) return;
      const acc = accounts[currentAccountId];
      transactions   = acc.transactions || [];
      exchanges      = acc.exchanges || [];
      capitalRecords = acc.capitalRecords || [];
      deposits       = acc.deposits || [];
      feeSettings    = acc.feeSettings || feeSettings;
      updateTransactionTable(); updateExchangeTable(); updatePortfolio();
      updateCapitalTable(); updateDepositTable(); updateDepositStats();
      loadFeeSettings(); updateAnalysis(); updateAccountMeta();
    }
    function flushWorkingSetsToAccount(){
      if (!currentAccountId) return;
      if (!accounts[currentAccountId]) accounts[currentAccountId] = createEmptyAccount();
      accounts[currentAccountId].transactions   = transactions;
      accounts[currentAccountId].exchanges      = exchanges;
      accounts[currentAccountId].capitalRecords = capitalRecords;
      accounts[currentAccountId].deposits       = deposits;
      accounts[currentAccountId].feeSettings    = feeSettings;
    }
    function refreshAccountSelect(){
      const sel = document.getElementById('accountSelect'); if(!sel) return;
      sel.innerHTML = '';
      Object.values(accounts).forEach(acc=>{
        const opt = document.createElement('option');
        opt.value = acc.id; opt.textContent = `${acc.name} (${acc.type})`;
        if (acc.id === currentAccountId) opt.selected = true;
        sel.appendChild(opt);
      });
    }
    function onAccountChange(id){ flushWorkingSetsToAccount(); currentAccountId=id; saveLocalData(); hydrateFromAccount(); showNotification('å·²åˆ‡æ›å¸³æˆ¶','success'); }
    function createAccount(){
      const name = prompt('æ–°å¸³æˆ¶åç¨±ï¼ˆä¾‹ï¼šç¾è‚¡é•·æŠ•ï¼æ•™è‚²åŸºé‡‘ï¼‰','æ–°å¸³æˆ¶'); if(!name) return;
      const type = prompt('äº¤æ˜“é¡å‹ï¼ˆä¾‹ï¼šç¾è‚¡ï¼èè³‡ï¼è¤‡å§”è¨—ï¼ETFï¼å…¶ä»–ï¼‰','ç¾è‚¡') || 'ç¾è‚¡';
      const baseCurrency = prompt('åŸºç¤å¹£åˆ¥ï¼ˆTWDï¼USDï¼CNY ...ï¼‰','TWD') || 'TWD';
      const acc = createEmptyAccount(name,type,baseCurrency);
      accounts[acc.id]=acc; currentAccountId=acc.id; refreshAccountSelect(); hydrateFromAccount(); saveLocalData(); showNotification('å·²æ–°å¢å¸³æˆ¶','success');
    }
    function renameAccount(){ if(!currentAccountId) return; const acc=accounts[currentAccountId]; const name=prompt('é‡æ–°å‘½åå¸³æˆ¶',acc.name); if(!name) return; acc.name=name; refreshAccountSelect(); updateAccountMeta(); saveLocalData(); showNotification('å¸³æˆ¶å·²é‡æ–°å‘½å','success'); }
    function removeAccount(){
      if(!currentAccountId) return;
      if(Object.keys(accounts).length<=1) return alert('è‡³å°‘éœ€ä¿ç•™ä¸€å€‹å¸³æˆ¶');
      if(!confirm('ç¢ºå®šåˆªé™¤æ­¤å¸³æˆ¶ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
      delete accounts[currentAccountId]; currentAccountId=Object.keys(accounts)[0]; saveLocalData(); refreshAccountSelect(); hydrateFromAccount(); showNotification('å¸³æˆ¶å·²åˆªé™¤','success');
    }
    function updateAccountMeta(){
      const el = document.getElementById('accountMeta'); if(!el) return;
      const acc = accounts[currentAccountId]; if(!acc){ el.textContent=''; return; }
      el.textContent = `å¸³æˆ¶IDï¼š${acc.id}ï½œé¡å‹ï¼š${acc.type}ï½œåŸºç¤å¹£åˆ¥ï¼š${acc.baseCurrency}`;
    }
    function initAccounts(){
      try{
        const saved = localStorage.getItem('accounts');
        const selected = localStorage.getItem('selectedAccountId');
        if(saved){
          accounts = JSON.parse(saved) || {};
          currentAccountId = selected || Object.keys(accounts)[0];
        }else{
          const def = createEmptyAccount('é è¨­å¸³æˆ¶','ç¾è‚¡','TWD');
          def.transactions   = JSON.parse(localStorage.getItem('stockTransactions') || '[]');
          def.exchanges      = JSON.parse(localStorage.getItem('exchangeRecords') || '[]');
          def.capitalRecords = JSON.parse(localStorage.getItem('capitalRecords') || '[]');
          def.deposits       = JSON.parse(localStorage.getItem('depositRecords') || '[]');
          const savedSettings = localStorage.getItem('feeSettings');
          def.feeSettings = savedSettings ? JSON.parse(savedSettings) : feeSettings;
          accounts[def.id] = def; currentAccountId = def.id;
          localStorage.setItem('accounts', JSON.stringify(accounts));
          localStorage.setItem('selectedAccountId', currentAccountId);
        }
        Object.values(accounts).forEach(acc=>{ if(!acc.deposits) acc.deposits=[]; });
      }catch(e){
        console.error('å¸³æˆ¶è®€å–å¤±æ•—ï¼Œå»ºç«‹é è¨­å¸³æˆ¶', e);
        const def = createEmptyAccount(); accounts = { [def.id]: def }; currentAccountId = def.id;
      }
      refreshAccountSelect(); hydrateFromAccount();
    }
    function loadLocalData(){ initAccounts(); }
    function saveLocalData(){
      try{
        flushWorkingSetsToAccount();
        localStorage.setItem('accounts', JSON.stringify(accounts));
        localStorage.setItem('selectedAccountId', currentAccountId);
        // èˆ‡èˆŠç‰ˆç›¸å®¹
        localStorage.setItem('stockTransactions', JSON.stringify(transactions));
        localStorage.setItem('exchangeRecords', JSON.stringify(exchanges));
        localStorage.setItem('capitalRecords', JSON.stringify(capitalRecords));
        localStorage.setItem('depositRecords', JSON.stringify(deposits));
        localStorage.setItem('feeSettings', JSON.stringify(feeSettings));
        localStorage.setItem('appSettings', JSON.stringify(appSettings));
      }catch(e){ console.error('å„²å­˜æœ¬åœ°è³‡æ–™å¤±æ•—:', e); }
    }

    // =========================
    // å®šå­˜ç³»çµ±
    // =========================
    function calculateDepositInterest(){
      const startDate = document.getElementById('depositStartDate').value;
      const endDate   = document.getElementById('depositEndDate').value;
      const principal = parseFloat(document.getElementById('depositPrincipal').value)||0;
      const rate      = parseFloat(document.getElementById('depositRate').value)||0;
      const type      = document.getElementById('depositInterestType').value;
      if(!startDate||!endDate||!principal||!rate) return;
      const start=new Date(startDate), end=new Date(endDate);
      const days = Math.max(0, Math.ceil((end - start) / (1000*60*60*24)));
      const months = Math.round(days / 30.44);
      const years  = days / 365.25;
      document.getElementById('depositTerm').value = months;
      let interest=0, maturity=0;
      if (type==='simple'){ interest = principal * (rate/100) * years; maturity = principal + interest; }
      else { const mRate=rate/100/12; maturity = principal * Math.pow(1+mRate, months); interest = maturity - principal; }
      document.getElementById('depositInterest').value = interest.toFixed(2);
      document.getElementById('depositMaturityAmount').value = maturity.toFixed(2);
    }
    function updateDepositTable(){
      const tbody = document.getElementById('depositTable'); if(!tbody) return;
      tbody.innerHTML='';
      const sorted = [...deposits].sort((a,b)=> new Date(b.startDate)-new Date(a.startDate));
      sorted.forEach(d=>{
        const tr = tbody.insertRow();
        const today = new Date(), endDate=new Date(d.endDate);
        const status = endDate>today ? 'é€²è¡Œä¸­' : 'å·²åˆ°æœŸ';
        const color  = endDate>today ? '#28a745' : '#6c757d';
        tr.innerHTML = `
          <td>${d.bank}</td>
          <td>${d.type}</td>
          <td>${d.currency}</td>
          <td>${Number(d.principal).toLocaleString()}</td>
          <td>${Number(d.rate).toFixed(2)}%</td>
          <td>${d.term}å€‹æœˆ</td>
          <td>${d.startDate}</td>
          <td>${d.endDate}</td>
          <td class="profit">${Number(d.interest).toFixed(2)}</td>
          <td class="profit">${Number(d.maturityAmount).toFixed(2)}</td>
          <td style="color:${color};font-weight:600;">${status}</td>
          <td>${d.note||'-'}</td>
          <td><button class="delete-btn" onclick="deleteDeposit(${d.id})">åˆªé™¤</button></td>
        `;
      });
    }
    function updateDepositStats(){
      const today = new Date();
      const active = deposits.filter(d=> new Date(d.endDate)>today);
      const totalPrincipal = deposits.reduce((s,d)=> s + (Number(d.principal)||0), 0);
      const totalInterest  = deposits.reduce((s,d)=> s + (Number(d.interest)||0), 0);
      const avgRate = deposits.length ? (deposits.reduce((s,d)=> s + (Number(d.rate)||0), 0) / deposits.length) : 0;
      document.getElementById('totalDepositPrincipal').textContent = totalPrincipal.toFixed(2);
      document.getElementById('totalDepositInterest').textContent  = totalInterest.toFixed(2);
      document.getElementById('activeDepositsCount').textContent   = active.length;
      document.getElementById('avgDepositRate').textContent        = `${avgRate.toFixed(2)}%`;
    }
    function deleteDeposit(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®šå­˜è¨˜éŒ„å—ï¼Ÿ')) return;
      deposits = deposits.filter(d=> d.id!==id);
      saveLocalData(); updateDepositTable(); updateDepositStats(); showNotification('å®šå­˜è¨˜éŒ„å·²åˆªé™¤','success');
    }

    // =========================
    // è³‡æœ¬ç®¡ç†
    // =========================
    function updateCapitalTable(){
      const tbody = document.getElementById('capitalTable'); if(!tbody) return;
      tbody.innerHTML='';
      const sorted = [...capitalRecords].sort((a,b)=> new Date(b.date)-new Date(a.date));
      let cum=0, ordered=[...capitalRecords].sort((a,b)=> new Date(a.date)-new Date(b.date)), cumMap={};
      ordered.forEach(r=>{ cum += (r.type==='è³‡é‡‘æå–' ? -r.amount : r.amount); cumMap[r.id]=cum; });
      sorted.forEach(r=>{
        const tr = tbody.insertRow();
        const color = r.type==='è³‡é‡‘æå–' ? '#dc3545' : '#28a745';
        const amt   = r.type==='è³‡é‡‘æå–' ? `-${r.amount.toFixed(2)}` : `+${r.amount.toFixed(2)}`;
        tr.innerHTML = `
          <td>${r.date}</td>
          <td style="color:${color};font-weight:600;">${r.type}</td>
          <td style="color:${color};font-weight:600;">${amt}</td>
          <td>${(cumMap[r.id]||0).toFixed(2)}</td>
          <td>${r.note||'-'}</td>
          <td><button class="delete-btn" onclick="deleteCapitalRecord(${r.id})">åˆªé™¤</button></td>
        `;
      });
      updateCapitalStats();
    }
    function updateCapitalStats(){
      let totalCapital=0,totalInvested=0;
      capitalRecords.forEach(r=>{ totalCapital += (r.type==='è³‡é‡‘æå–' ? -r.amount : r.amount); });
      transactions.forEach(t=>{ totalInvested += (t.type==='è²·é€²' ? t.totalAmount : -t.totalAmount); });
      const available = totalCapital - totalInvested;
      document.getElementById('totalCapital').textContent = totalCapital.toFixed(2);
      document.getElementById('availableCapital').textContent = available.toFixed(2);
      document.getElementById('investedCapital').textContent = totalInvested.toFixed(2);
      document.getElementById('availableCapital').className = available>=0 ? 'stat-value' : 'stat-value loss';
    }
    function deleteCapitalRecord(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æœ¬ç´€éŒ„å—ï¼Ÿ')) return;
      capitalRecords = capitalRecords.filter(r=> r.id!==id);
      saveLocalData(); updateCapitalTable(); updateCapitalStats(); updateAnalysis();
      showNotification('è³‡æœ¬ç´€éŒ„å·²åˆªé™¤','success');
    }

    // =========================
    // äº¤æ˜“/æ›åŒ¯è¡¨æ ¼ & æ“ä½œ
    // =========================
    function updateTransactionTable(){
      const tbody = document.getElementById('transactionTable'); if(!tbody) return;
      tbody.innerHTML='';
      const sorted = [...transactions].sort((a,b)=> new Date(b.date)-new Date(a.date));
      sorted.forEach(t=>{
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td>${t.date}</td>
          <td><span class="market-indicator market-${t.market.toLowerCase()}">${t.market}</span></td>
          <td>${t.symbol}</td>
          <td>${t.name}</td>
          <td><span style="color:${t.type==='è²·é€²'?'#28a745':'#dc3545'}">${t.type}</span></td>
          <td>${t.quantity.toLocaleString()}</td>
          <td>${t.price.toFixed(2)}</td>
          <td>${t.isOddLot ? 'âœ“' : 'âœ—'}</td>
          <td>${t.fee.toFixed(2)}</td>
          <td>${t.tax.toFixed(2)}</td>
          <td>${t.totalAmount.toFixed(2)}</td>
          <td>${t.note||'-'}</td>
          <td><button class="delete-btn" onclick="deleteTransaction(${t.id})">åˆªé™¤</button></td>
        `;
      });
    }
    function updateExchangeTable(){
      const tbody = document.getElementById('exchangeTable'); if(!tbody) return;
      tbody.innerHTML='';
      const sorted = [...exchanges].sort((a,b)=> new Date(b.date)-new Date(a.date));
      sorted.forEach(e=>{
        const [from,to] = e.type.split('-');
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${from} â†’ ${to}</td>
          <td>${e.fromAmount.toLocaleString()} ${from}</td>
          <td>${e.rate.toFixed(4)}</td>
          <td>${e.toAmount.toLocaleString()} ${to}</td>
          <td>${e.fee.toFixed(2)}</td>
          <td>${e.bank||'-'}</td>
          <td>${e.note||'-'}</td>
          <td><button class="delete-btn" onclick="deleteExchange(${e.id})">åˆªé™¤</button></td>
        `;
      });
    }
    function deleteTransaction(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“ç´€éŒ„å—ï¼Ÿ')) return;
      transactions = transactions.filter(t=> t.id!==id);
      saveLocalData(); updateTransactionTable(); updatePortfolio(); updateAnalysis();
      showNotification('äº¤æ˜“ç´€éŒ„å·²åˆªé™¤','success');
    }
    function deleteExchange(id){
      if(!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›åŒ¯ç´€éŒ„å—ï¼Ÿ')) return;
      exchanges = exchanges.filter(e=> e.id!==id);
      saveLocalData(); updateExchangeTable(); updateAnalysis();
      showNotification('æ›åŒ¯ç´€éŒ„å·²åˆªé™¤','success');
    }
    function calculateExchangeAmount(){
      const fromAmount = parseFloat(document.getElementById('fromAmount').value)||0;
      const rate = parseFloat(document.getElementById('exchangeRate').value)||0;
      if (fromAmount && rate) document.getElementById('toAmount').value = (fromAmount*rate).toFixed(4);
    }

    // =========================
    // è²»ç”¨è¨ˆç®—
    // =========================
    function calculateFees(){
      const market = document.getElementById('market').value;
      const quantity = parseFloat(document.getElementById('quantity').value)||0;
      const price = parseFloat(document.getElementById('price').value)||0;
      const type = document.getElementById('type').value;
      const isOddLot = document.getElementById('oddLot').value === 'true';
      if(!market||!quantity||!price){ document.getElementById('fee').value=''; document.getElementById('tax').value=''; return; }
      const total = quantity * price; let fee=0,tax=0;
      if(market==='TW'){
        const feeRate = feeSettings.tw.feeRate/100;
        fee = Math.max(total*feeRate, isOddLot?feeSettings.tw.oddLotMinFee:feeSettings.tw.minFee);
        if(type==='è³£å‡º') tax = total * (feeSettings.tw.taxRate/100);
      }else if(market==='US'){
        if(feeSettings.us.feeType==='fixed') fee = feeSettings.us.fixedFee;
        else fee = Math.max(total*(feeSettings.us.feeRate/100), feeSettings.us.minFee);
      }
      document.getElementById('fee').value = fee.toFixed(2);
      document.getElementById('tax').value = tax.toFixed(2);
    }

    // =========================
    // æŒå€‰ & åˆ†æï¼ˆå«å³æ™‚å ±åƒ¹ï¼‰
    // =========================
    function updatePortfolio(){
      const portfolio = {};
      transactions.forEach(t=>{
        const key = `${t.market}-${t.symbol}`;
        if(!portfolio[key]) portfolio[key] = { market:t.market, symbol:t.symbol, name:t.name, totalQuantity:0, totalCost:0 };
        if (t.type==='è²·é€²'){ portfolio[key].totalQuantity += t.quantity; portfolio[key].totalCost += t.totalAmount; }
        else { // è³£å‡º
          portfolio[key].totalQuantity -= t.quantity;
          if (portfolio[key].totalQuantity + t.quantity > 0){
            const avg = portfolio[key].totalCost / (portfolio[key].totalQuantity + t.quantity);
            portfolio[key].totalCost -= t.quantity * avg;
          }
        }
      });
      const tbody = document.getElementById('portfolioTable'); if(!tbody) return;
      tbody.innerHTML='';
      Object.values(portfolio).forEach(h=>{
        if (h.totalQuantity>0){
          const avgCost = h.totalCost / h.totalQuantity;
          const currentPrice = getCurrentPrice(h.symbol,h.market);
          const marketValue = h.totalQuantity * currentPrice;
          const unrealized  = marketValue - h.totalCost;
          const rr = (unrealized / h.totalCost) * 100;
          const tr = tbody.insertRow();
          tr.innerHTML = `
            <td><span class="market-indicator market-${h.market.toLowerCase()}">${h.market}</span></td>
            <td>${h.symbol}</td>
            <td>${h.name}</td>
            <td>${h.totalQuantity.toLocaleString()}</td>
            <td>${avgCost.toFixed(2)}</td>
            <td>${h.totalCost.toFixed(2)}</td>
            <td>${currentPrice.toFixed(2)}</td>
            <td>${marketValue.toFixed(2)}</td>
            <td class="${unrealized>=0?'profit':'loss'}">${unrealized.toFixed(2)}</td>
            <td class="${rr>=0?'profit':'loss'}">${rr.toFixed(2)}%</td>
            <td><button class="btn-sell" onclick="openSellModal('${h.market}','${h.symbol}','${h.name}',${h.totalQuantity})">å¿«é€Ÿè³£å‡º</button></td>
          `;
        }
      });
    }
    function updateAnalysis(){
      let totalInvestment=0,totalValue=0,totalExchangeFee=0;
      const pos={};
      transactions.forEach(t=>{
        const key = `${t.market}-${t.symbol}`;
        if(!pos[key]) pos[key]={ qty:0, cost:0, name:t.name };
        if (t.type==='è²·é€²'){ pos[key].qty += t.quantity; pos[key].cost += t.totalAmount; }
        else {
          pos[key].qty -= t.quantity;
          if (pos[key].qty + t.quantity > 0){
            const avg = pos[key].cost / (pos[key].qty + t.quantity);
            pos[key].cost -= t.quantity * avg;
          }
        }
      });
      Object.entries(pos).forEach(([key,h])=>{
        if (h.qty>0){ totalInvestment += h.cost; const [mkt,sym] = key.split('-'); const p = getCurrentPrice(sym,mkt); totalValue += h.qty*p; }
      });
      exchanges.forEach(e=> totalExchangeFee += e.fee);
      const profit = totalValue - totalInvestment;
      const ret = totalInvestment>0 ? (profit/totalInvestment)*100 : 0;
      document.getElementById('totalInvestment').textContent = totalInvestment.toFixed(2);
      document.getElementById('totalValue').textContent      = totalValue.toFixed(2);
      const tp = document.getElementById('totalProfit'); tp.textContent=profit.toFixed(2); tp.className = profit>=0?'stat-value profit':'stat-value loss';
      const tr = document.getElementById('totalReturn'); tr.textContent=`${ret.toFixed(2)}%`; tr.className = ret>=0?'stat-value profit':'stat-value loss';
      document.getElementById('totalExchangeFee').textContent = totalExchangeFee.toFixed(2);

      const realized = computeRealizedPnLEvents();
      const rp = document.getElementById('realizedProfitTotal'); rp.textContent = realized.total.toFixed(2); rp.className = realized.total>=0?'stat-value profit':'stat-value loss';
      renderRealizedTable(realized.events);

      const fx = computeFxPnL();
      const fxp = document.getElementById('fxProfitTotal'); fxp.textContent = fx.total.toFixed(2); fxp.className = fx.total>=0?'stat-value profit':'stat-value loss';
      renderFxPnLTable(fx.events);
    }
    function computeRealizedPnLEvents(){
      const sorted = [...transactions].sort((a,b)=> new Date(a.date)-new Date(b.date) || a.id-b.id);
      const state={}, events=[]; let total=0;
      sorted.forEach(tx=>{
        const key = `${tx.market}-${tx.symbol}`;
        if (!state[key]) state[key] = { qty:0, cost:0, name:tx.name };
        if (tx.type==='è²·é€²'){ state[key].qty += tx.quantity; state[key].cost += tx.totalAmount; }
        else if (tx.type==='è³£å‡º'){
          const lotQty = Math.max(0, state[key].qty);
          const avgCost = lotQty>0 ? state[key].cost/lotQty : 0;
          const costPart = avgCost * tx.quantity;
          const proceeds = (tx.quantity * tx.price) - (tx.fee||0) - (tx.tax||0);
          const realized = proceeds - costPart;
          state[key].qty  -= tx.quantity;
          state[key].cost -= costPart;
          events.push({ id:tx.id, date:tx.date, market:tx.market, symbol:tx.symbol, name:tx.name, quantity:tx.quantity, avgCost, proceeds, cost:costPart, realized, returnPct: costPart>0?(realized/costPart)*100:0, note:tx.note||'' });
          total += realized;
        }
      });
      return { events, total };
    }
    function renderRealizedTable(list){
      const tbody = document.getElementById('realizedTable'); if(!tbody) return;
      tbody.innerHTML='';
      [...list].sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td><span class="market-indicator market-${r.market.toLowerCase()}">${r.market}</span></td>
          <td>${r.symbol}</td>
          <td>${r.name}</td>
          <td>${r.quantity.toLocaleString()}</td>
          <td>${r.avgCost.toFixed(2)}</td>
          <td>${r.proceeds.toFixed(2)}</td>
          <td>${r.cost.toFixed(2)}</td>
          <td class="${r.realized>=0?'profit':'loss'}">${r.realized.toFixed(2)}</td>
          <td class="${r.returnPct>=0?'profit':'loss'}">${r.returnPct.toFixed(2)}%</td>
          <td>${r.note||'-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }
    function computeFxPnL(){
      const sorted = [...exchanges].sort((a,b)=> new Date(a.date)-new Date(b.date) || a.id-b.id);
      const pos={}, events=[]; let total=0;
      const ensure = c=>{ if(!pos[c]) pos[c]= { qty:0, twdCost:0 }; };
      sorted.forEach(ex=>{
        const [from,to] = (ex.type||'').split('-');
        const fromAmt = Number(ex.fromAmount)||0;
        const toAmt   = Number(ex.toAmount)|| (fromAmt * (Number(ex.rate)||0));
        const rate    = Number(ex.rate)     || (fromAmt ? toAmt/fromAmt : 0);
        const fee     = Number(ex.fee)||0;
        let feeTwd=0; if(from==='TWD') feeTwd=fee; else if(to==='TWD') feeTwd=fee*rate; else feeTwd=0;
        ensure(from); ensure(to);
        if (from==='TWD'){
          pos[to].qty     += toAmt;
          pos[to].twdCost += (fromAmt + feeTwd);
          events.push({ id:ex.id, date:ex.date, pair:ex.type, action:'è²·å…¥å¤–å¹£', qty:toAmt, rate, feeTwd, realized:0, note:ex.note||'' });
        } else if (to==='TWD'){
          const available = pos[from].qty;
          const avgCost   = available>0 ? (pos[from].twdCost/available) : 0;
          const costTwd   = avgCost * fromAmt;
          const proceeds  = toAmt - feeTwd;
          const realized  = proceeds - costTwd;
          pos[from].qty     -= fromAmt;
          pos[from].twdCost -= costTwd;
          events.push({ id:ex.id, date:ex.date, pair:ex.type, action:'è³£å‡ºå¤–å¹£', qty:fromAmt, rate, feeTwd, realized, note:ex.note||'' });
          total += realized;
        } else {
          const available = pos[from].qty;
          const avgCost   = available>0 ? (pos[from].twdCost/available) : 0;
          const costFrom  = avgCost * fromAmt;
          pos[from].qty     -= fromAmt;
          pos[from].twdCost -= costFrom;
          pos[to].qty       += toAmt;
          pos[to].twdCost   += costFrom;
          events.push({ id:ex.id, date:ex.date, pair:ex.type, action:'å¹£åˆ¥è½‰æ›', qty:toAmt, rate, feeTwd:0, realized:0, note:ex.note||'' });
        }
      });
      return { events, total };
    }
    function renderFxPnLTable(list){
      const tbody = document.getElementById('fxPnLTable'); if(!tbody) return;
      tbody.innerHTML='';
      [...list].sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.pair}</td>
          <td>${r.action}</td>
          <td>${r.qty.toLocaleString()}</td>
          <td>${(r.rate||0).toFixed(4)}</td>
          <td>${(r.feeTwd||0).toFixed(2)}</td>
          <td class="${(r.realized||0)>=0?'profit':'loss'}">${(r.realized||0).toFixed(2)}</td>
          <td>${r.note||'-'}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // =========================
    // å³æ™‚å ±åƒ¹ï¼ˆTW: TWSE MISï¼›US: Finnhubï¼‰
    // =========================
    async function fetchTWSEQuote(symbol){
      const clean = String(symbol||'').replace(/\s+/g,'').toUpperCase();
      const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?json=1&delay=0&ex_ch=tse_${encodeURIComponent(clean)}.tw`;
      try{
        const res = await fetch(url,{cache:'no-cache'});
        if(!res.ok) return null;
        const data = await res.json();
        const arr = (data && data.msgArray) || [];
        if(!arr.length) return null;
        const it = arr[0] || {};
        const z = parseFloat(it.z), y = parseFloat(it.y);
        const price = (!isNaN(z) && z>0) ? z : (!isNaN(y) ? y : NaN);
        if (isNaN(price)) return null;
        return { price, name: it.n || '' };
      }catch(e){ console.warn('TWSE fetch error (å¯èƒ½ç‚º CORS)ï¼š', e); return null; }
    }
    async function fetchFinnhubQuote(symbol){
      const token = (appSettings.finnhubKey||'').trim();
      if(!token) return null;
      try{
        const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${encodeURIComponent(token)}`;
        const res = await fetch(url,{cache:'no-cache'});
        if(!res.ok) return null;
        const data = await res.json();
        const price = (typeof data.c==='number' && data.c>0) ? data.c : null;
        return price ? { price, name: String(symbol).toUpperCase() } : null;
      }catch(e){ console.warn('Finnhub APIéŒ¯èª¤ï¼š', e); return null; }
    }
    async function fetchMixedQuote(symbol,market){ return market==='TW' ? fetchTWSEQuote(symbol) : fetchFinnhubQuote(symbol); }
    function getCurrentPrice(symbol,market){
      const key = `${market}-${symbol}`;
      const useLive = (String(appSettings.useLivePrice)==='true') || appSettings.useLivePrice===true;
      const entry = currentPrices[key];
      const expired = !entry || !entry._ts || (Date.now() - entry._ts > 60*1000);
      if (useLive && expired){
        fetchMixedQuote(symbol,market).then(q=>{
          if(q && typeof q.price==='number' && q.price>0){
            currentPrices[key] = { value:q.price, name:q.name||'', _ts:Date.now() };
            updatePortfolio(); updateAnalysis();
          }
        }).catch(()=>{});
      }
      if (entry && typeof entry.value==='number') return entry.value;
      // fallbackï¼šä»¥æœ€è¿‘æˆäº¤åƒ¹å¾®æ“¾å‹•
      const last = transactions.filter(t=> t.symbol===symbol && t.market===market).sort((a,b)=> new Date(b.date)-new Date(a.date))[0];
      let value = last ? last.price * (1 + ((Math.random()-0.5)*0.1)) : 100;
      currentPrices[key] = { value, _ts:Date.now() };
      return value;
    }
    async function peekQuote(){
      const market = document.getElementById('market').value;
      const symbol = (document.getElementById('symbol').value||'').trim().toUpperCase();
      const hint = document.getElementById('lastQuoteHint');
      if(!market || !symbol){ if(hint) hint.textContent=''; return; }
      hint.textContent='æŸ¥è©¢ä¸­â€¦';
      const q = await fetchMixedQuote(symbol,market);
      if (q && typeof q.price==='number'){
        lastPeekPrice = q.price;
        hint.textContent = `å³æ™‚åƒ¹ï¼š${q.price.toFixed(2)}${q.name ? 'ï½œåç¨±ï¼š'+q.name : ''}`;
        if (q.name && !document.getElementById('name').value.trim()) document.getElementById('name').value = q.name;
      } else {
        hint.textContent = 'æŸ¥åƒ¹å¤±æ•—ï¼ˆå¯èƒ½ç‚ºAPIé™åˆ¶æˆ–ä»£è™Ÿæœ‰èª¤ï¼‰';
      }
    }
    async function fillCurrentPrice(){
      if (lastPeekPrice){ document.getElementById('price').value = lastPeekPrice.toFixed(2); calculateFees(); }
      else { await peekQuote(); if(lastPeekPrice){ document.getElementById('price').value = lastPeekPrice.toFixed(2); calculateFees(); } }
    }
    async function testApiConnection(){
      const el = document.getElementById('priceApiStatus');
      el.textContent='APIç‹€æ…‹ï¼šæ¸¬è©¦ä¸­â€¦'; el.className='api-status warning';
      try{
        const tw = await fetchMixedQuote('2330','TW');
        const us = await fetchMixedQuote('AAPL','US');
        let msg=[];
        msg.push(tw && tw.price ? `å°è‚¡æ­£å¸¸(2330: ${tw.price})` : 'å°è‚¡APIç•°å¸¸');
        msg.push(us && us.price ? `ç¾è‚¡æ­£å¸¸(AAPL: ${us.price})` : 'ç¾è‚¡APIç•°å¸¸');
        el.textContent = 'APIç‹€æ…‹ï¼š' + msg.join(' | ');
        el.className = (tw||us) ? 'api-status success' : 'api-status error';
      }catch(e){ el.textContent = `APIç‹€æ…‹ï¼šé€£ç·šå¤±æ•— (${e.message})`; el.className='api-status error'; }
    }

    // =========================
    // èªè­‰èˆ‡åŒæ­¥ï¼ˆä¿®æ­£ï¼šä½¿ç”¨ compat APIï¼‰
    // =========================
    async function signUp(){
      const email=document.getElementById('userEmail').value, password=document.getElementById('userPassword').value;
      if(!email || !password) return showNotification('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼','error');
      try{ showLoading(true); await FB.createUser(email,password); showNotification('è¨»å†ŠæˆåŠŸï¼','success'); document.getElementById('userEmail').value=''; document.getElementById('userPassword').value=''; updateSyncStatus('ç™»å…¥ç‹€æ…‹ï¼šç·šä¸Š', true); }
      catch(e){ showNotification('è¨»å†Šå¤±æ•—: '+e.message,'error'); }
      finally{ showLoading(false); }
    }
    async function signIn(){
      const email=document.getElementById('userEmail').value, password=document.getElementById('userPassword').value;
      if(!email || !password) return showNotification('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼','error');
      try{ showLoading(true); await FB.signIn(email,password); showNotification('ç™»å…¥æˆåŠŸï¼','success'); document.getElementById('userEmail').value=''; document.getElementById('userPassword').value=''; updateSyncStatus('ç™»å…¥ç‹€æ…‹ï¼šç·šä¸Š', true); await loadUserData(); }
      catch(e){ showNotification('ç™»å…¥å¤±æ•—: '+e.message,'error'); }
      finally{ showLoading(false); }
    }
    async function signOut(){
      try{ if(!FB.ready) return showNotification('ç›®å‰ç‚ºæœ¬åœ°æ¨¡å¼ï¼Œç„¡éœ€ç™»å‡º','error'); await FB.signOut(); showNotification('å·²ç™»å‡º','success'); updateSyncStatus('é›¢ç·šæ¨¡å¼', false); }
      catch(e){ showNotification('ç™»å‡ºå¤±æ•—: '+e.message,'error'); }
    }
    async function syncData(){
      if(!FB.ready || !FB.currentUser()) return showNotification('è«‹å…ˆç™»å…¥','error');
      try{
        showLoading(true);
        const userId = FB.currentUser().uid;
        flushWorkingSetsToAccount();
        const payload = { accounts, selectedAccountId: currentAccountId, lastSync:new Date().toISOString(), version:'2.1.0' };
        await FB.set(`users/${userId}`, payload);
        showNotification('è³‡æ–™åŒæ­¥æˆåŠŸï¼','success');
      }catch(e){ showNotification('åŒæ­¥å¤±æ•—: '+e.message,'error'); }
      finally{ showLoading(false); }
    }
    async function loadUserData(){
      if(!FB.ready || !FB.currentUser()) return;
      try{
        showLoading(true);
        const userId = FB.currentUser().uid;
        const snap = await FB.get(`users/${userId}`);
        if (snap && snap.exists()){
          const userData = snap.val();
          if (userData.accounts){
            accounts = userData.accounts || {};
            currentAccountId = userData.selectedAccountId || Object.keys(accounts)[0];
            Object.values(accounts).forEach(acc=>{ if(!acc.deposits) acc.deposits=[]; });
            refreshAccountSelect(); hydrateFromAccount(); showNotification('è³‡æ–™è¼‰å…¥æˆåŠŸ','success');
          }
        }
      }catch(e){ showNotification('è¼‰å…¥è³‡æ–™å¤±æ•—: '+e.message,'error'); loadLocalData(); }
      finally{ showLoading(false); }
    }

    // =========================
    // è¨­å®š
    // =========================
    function loadFeeSettings(){
      document.getElementById('twFeeRate').value = feeSettings.tw.feeRate;
      document.getElementById('twMinFee').value = feeSettings.tw.minFee;
      document.getElementById('twOddLotMinFee').value = feeSettings.tw.oddLotMinFee;
      document.getElementById('twTaxRate').value = feeSettings.tw.taxRate;
      document.getElementById('usFeeType').value = feeSettings.us.feeType;
      document.getElementById('usFixedFee').value = feeSettings.us.fixedFee;
      document.getElementById('usFeeRate').value = feeSettings.us.feeRate;
      document.getElementById('usMinFee').value = feeSettings.us.minFee;
    }
    function saveFeeSettings(){
      feeSettings.tw.feeRate = parseFloat(document.getElementById('twFeeRate').value);
      feeSettings.tw.minFee  = parseFloat(document.getElementById('twMinFee').value);
      feeSettings.tw.oddLotMinFee = parseFloat(document.getElementById('twOddLotMinFee').value);
      feeSettings.tw.taxRate = parseFloat(document.getElementById('twTaxRate').value);
      feeSettings.us.feeType = document.getElementById('usFeeType').value;
      feeSettings.us.fixedFee = parseFloat(document.getElementById('usFixedFee').value);
      feeSettings.us.feeRate = parseFloat(document.getElementById('usFeeRate').value);
      feeSettings.us.minFee = parseFloat(document.getElementById('usMinFee').value);
      saveLocalData(); showNotification('è²»ç‡è¨­å®šå·²å„²å­˜ï¼','success');
    }
    function resetFeeSettings(){
      if(!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è²»ç‡è¨­å®šå—ï¼Ÿ')) return;
      feeSettings = { tw:{ feeRate:0.1425, minFee:20, oddLotMinFee:1, taxRate:0.3 }, us:{ feeType:'fixed', fixedFee:0, feeRate:0, minFee:0 } };
      saveLocalData(); loadFeeSettings(); showNotification('å·²é‡ç½®ç‚ºé è¨­è¨­å®šï¼','success');
    }
    function loadAppSettingsUI(){
      const use = document.getElementById('useLivePrice');
      const key = document.getElementById('finnhubKey');
      if (use) use.value = String(appSettings.useLivePrice ? 'true':'false');
      if (key) key.value = appSettings.finnhubKey || '';
      const cfg = document.getElementById('firebaseConfig');
      if (cfg) cfg.value = JSON.stringify(firebaseConfig, null, 2);
    }
    function saveAppSettings(){
      const use = document.getElementById('useLivePrice');
      const key = document.getElementById('finnhubKey');
      appSettings.useLivePrice = (use && use.value==='true');
      appSettings.finnhubKey   = (key && key.value ? key.value.trim() : '') || 'd30rabhr01qnu2qvafv0d30rabhr01qnu2qvafvg';
      localStorage.setItem('appSettings', JSON.stringify(appSettings));
      currentPrices = {}; updatePortfolio(); updateAnalysis();
      showNotification('å ±åƒ¹è¨­å®šå·²å„²å­˜','success');
    }
    function saveFirebaseConfig(){
      const el = document.getElementById('firebaseConfig'); if(!el) return;
      try{
        const cfg = JSON.parse(el.value.trim());
        if (!cfg.apiKey || !cfg.authDomain || !cfg.databaseURL || !cfg.projectId) throw new Error('è¨­å®šç¼ºå°‘å¿…è¦æ¬„ä½');
        firebaseConfig = cfg; localStorage.setItem('firebaseConfig', JSON.stringify(cfg));
        showNotification('Firebaseè¨­å®šå·²å„²å­˜ï¼Œè«‹é»ã€Œé‡æ–°åˆå§‹åŒ–ã€','success');
      }catch(e){ showNotification('Firebaseè¨­å®šæ ¼å¼éŒ¯èª¤: '+e.message,'error'); }
    }
    function initializeFirebase(){ try{ FB.init(); showNotification('Firebaseå·²é‡æ–°åˆå§‹åŒ–','success'); } catch(e){ showNotification('Firebaseåˆå§‹åŒ–å¤±æ•—: '+e.message,'error'); } }

    // =========================
    // åŒ¯å‡º / åŒ¯å…¥ / æ¸…ç©º
    // =========================
    function exportToCSV(type){
      let csv='', name='';
      if (type==='transactions'){
        csv = 'Date,Market,Symbol,Name,Type,Quantity,Price,OddLot,Fee,Tax,Total Amount,Note\n';
        transactions.forEach(t=>{ csv += `${t.date},${t.market},${t.symbol},"${t.name}",${t.type},${t.quantity},${t.price},${t.isOddLot?'Yes':'No'},${t.fee},${t.tax},${t.totalAmount},"${t.note||''}"\n`; });
        name='stock_transactions.csv';
      } else if (type==='exchange'){
        csv = 'Date,Exchange Type,From Amount,Rate,To Amount,Fee,Bank,Note\n';
        exchanges.forEach(e=>{ csv += `${e.date},${e.type},${e.fromAmount},${e.rate},${e.toAmount},${e.fee},"${e.bank||''}","${e.note||''}"\n`; });
        name='exchange_records.csv';
      } else if (type==='capital'){
        csv = 'Date,Type,Amount,Note\n';
        capitalRecords.forEach(c=>{ csv += `${c.date},${c.type},${c.amount},"${c.note||''}"\n`; });
        name='capital_records.csv';
      } else if (type==='deposits'){
        csv = 'Start Date,End Date,Bank,Type,Currency,Principal,Rate,Term(Months),Interest Type,Interest,Maturity Amount,Note\n';
        deposits.forEach(d=>{ csv += `${d.startDate},${d.endDate},"${d.bank}","${d.type}",${d.currency},${d.principal},${d.rate},${d.term},"${d.interestType}",${d.interest},${d.maturityAmount},"${d.note||''}"\n`; });
        name='deposit_records.csv';
      }
      const blob = new Blob(['\ufeff'+csv], {type:'text/csv;charset=utf-8;'}), url = URL.createObjectURL(blob);
      const link = document.createElement('a'); link.href=url; link.download=name; document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }
    function exportAllData(){
      flushWorkingSetsToAccount();
      const data = { accounts, selectedAccountId: currentAccountId, appSettings, exportDate:new Date().toISOString(), version:'2.1.0' };
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob), a=document.createElement('a'); a.href=url; a.download=`portfolio_backup_${new Date().toISOString().split('T')[0]}.json`; a.click();
      showNotification('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰','success');
    }
    function importData(input){
      const file = input.files[0]; if(!file) return;
      const reader = new FileReader();
      reader.onload = e=>{
        try{
          const data = JSON.parse(e.target.result);
          if (data.accounts){
            if (!confirm('ç¢ºå®šè¦åŒ¯å…¥å‚™ä»½è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼')) return;
            accounts = data.accounts; currentAccountId = data.selectedAccountId || Object.keys(accounts)[0];
            if (data.appSettings){ appSettings = {...appSettings, ...data.appSettings}; localStorage.setItem('appSettings', JSON.stringify(appSettings)); }
            Object.values(accounts).forEach(acc=>{ if(!acc.deposits) acc.deposits=[]; });
            saveLocalData(); refreshAccountSelect(); hydrateFromAccount(); loadAppSettingsUI(); showNotification(`æˆåŠŸåŒ¯å…¥ ${Object.keys(accounts).length} å€‹å¸³æˆ¶çš„è³‡æ–™ï¼`,'success');
          } else {
            if (!confirm('æª¢æ¸¬åˆ°èˆŠç‰ˆæ ¼å¼ï¼Œå°‡è½‰æ›ç‚ºæ–°çš„å¸³æˆ¶åˆ¶åº¦ã€‚ç¢ºå®šåŒ¯å…¥å—ï¼Ÿ')) return;
            const acc = createEmptyAccount('åŒ¯å…¥å¸³æˆ¶','ç¾è‚¡','TWD');
            acc.transactions = data.transactions || []; acc.exchanges = data.exchanges || []; acc.capitalRecords = data.capitalRecords || []; acc.deposits = data.deposits || []; acc.feeSettings = data.feeSettings || feeSettings;
            accounts[acc.id]=acc; currentAccountId=acc.id; saveLocalData(); refreshAccountSelect(); hydrateFromAccount(); showNotification('èˆŠç‰ˆè³‡æ–™å·²è½‰æ›ä¸¦åŒ¯å…¥ï¼','success');
          }
        }catch(_){ showNotification('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤','error'); }
      };
      reader.readAsText(file); input.value='';
    }
    function clearAllData(){
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
      if (!confirm('æœ€å¾Œç¢ºèªï¼šé€™å°‡åˆªé™¤æ‰€æœ‰å¸³æˆ¶ã€äº¤æ˜“è¨˜éŒ„å’Œè¨­å®šï¼')) return;
      transactions=[]; exchanges=[]; capitalRecords=[]; deposits=[]; currentPrices={}; accounts={}; currentAccountId=null;
      const def = createEmptyAccount('é è¨­å¸³æˆ¶','ç¾è‚¡','TWD'); accounts[def.id]=def; currentAccountId=def.id;
      saveLocalData(); refreshAccountSelect(); hydrateFromAccount(); updateTransactionTable(); updateExchangeTable(); updatePortfolio(); updateCapitalTable(); updateDepositTable(); updateDepositStats(); updateAnalysis();
      showNotification('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºä¸¦é‡æ–°åˆå§‹åŒ–ï¼','success');
    }

    // =========================
    // å¿«é€Ÿè³£å‡º
    // =========================
    function openSellModal(market,symbol,name,availableQuantity){
      currentSellStock = { market, symbol, name, availableQuantity };
      document.getElementById('sellStockInfo').value = `${market}-${symbol} (${name})`;
      document.getElementById('sellAvailableQuantity').value = availableQuantity;
      document.getElementById('sellQuantity').value = '';
      document.getElementById('sellQuantity').max = availableQuantity;
      document.getElementById('sellPrice').value = '';
      document.getElementById('sellNote').value = '';
      setDefaultDates();
      document.getElementById('sellModal').style.display='block';
    }
    function closeSellModal(){ document.getElementById('sellModal').style.display='none'; currentSellStock=null; document.getElementById('sellForm').reset(); }

    // =========================
    // äº‹ä»¶ç¶å®š
    // =========================
    function bindFormEvents(){
      const debounce=(fn,t=350)=>{ let id; return (...args)=>{ clearTimeout(id); id=setTimeout(()=>fn(...args),t); }; };
      const debouncedPeekQuote = debounce(peekQuote, 450);

      // è¨ˆç®—/æŸ¥åƒ¹æ¬„ä½
      const fa = document.getElementById('fromAmount'), er=document.getElementById('exchangeRate'); if(fa) fa.addEventListener('input', calculateExchangeAmount); if(er) er.addEventListener('input', calculateExchangeAmount);
      ['market','quantity','price','type','oddLot'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('change', calculateFees); el.addEventListener('input', calculateFees); } });
      const symbolEl=document.getElementById('symbol'); if(symbolEl) symbolEl.addEventListener('input', debouncedPeekQuote);
      const marketEl=document.getElementById('market'); if(marketEl){
        marketEl.addEventListener('change', function(){
          const oddLotGroup = document.getElementById('oddLot').parentElement;
          if (this.value==='TW'){ oddLotGroup.style.display='flex'; } else { oddLotGroup.style.display='none'; document.getElementById('oddLot').value='false'; }
          calculateFees(); debouncedPeekQuote();
        });
      }
      // å®šå­˜è‡ªå‹•è¨ˆç®—
      ['depositStartDate','depositEndDate','depositPrincipal','depositRate','depositInterestType'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('change', calculateDepositInterest); el.addEventListener('input', calculateDepositInterest); } });
      // Modal èƒŒæ™¯é—œé–‰
      window.addEventListener('click', ev=>{ const m=document.getElementById('sellModal'); if(ev.target===m) closeSellModal(); });
    }
    function initializeFormEvents(){
      // äº¤æ˜“è¡¨å–®
      document.getElementById('transactionForm').addEventListener('submit', function(e){
        e.preventDefault();
        const t = {
          id:Date.now(), date:document.getElementById('date').value, market:document.getElementById('market').value,
          symbol:document.getElementById('symbol').value.toUpperCase().trim(), name:document.getElementById('name').value.trim(),
          type:document.getElementById('type').value, quantity:parseFloat(document.getElementById('quantity').value),
          price:parseFloat(document.getElementById('price').value), isOddLot:document.getElementById('oddLot').value==='true',
          fee:parseFloat(document.getElementById('fee').value)||0, tax:parseFloat(document.getElementById('tax').value)||0,
          note:document.getElementById('note').value
        };
        t.totalAmount = (t.type==='è²·é€²') ? (t.quantity*t.price + t.fee + t.tax) : (t.quantity*t.price - t.fee - t.tax);
        transactions.push(t); saveLocalData(); updateTransactionTable(); updatePortfolio(); updateAnalysis();
        this.reset(); setDefaultDates(); document.getElementById('oddLot').value='false'; document.getElementById('lastQuoteHint').textContent='';
        showNotification('äº¤æ˜“ç´€éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
      });
      // æ›åŒ¯è¡¨å–®
      document.getElementById('exchangeForm').addEventListener('submit', function(e){
        e.preventDefault();
        const ex = {
          id:Date.now(), date:document.getElementById('exchangeDate').value, type:document.getElementById('exchangeType').value,
          fromAmount:parseFloat(document.getElementById('fromAmount').value), rate:parseFloat(document.getElementById('exchangeRate').value),
          toAmount:parseFloat(document.getElementById('toAmount').value), fee:parseFloat(document.getElementById('exchangeFee').value)||0,
          bank:document.getElementById('exchangeBank').value, note:document.getElementById('exchangeNote').value
        };
        exchanges.push(ex); saveLocalData(); updateExchangeTable(); updateAnalysis(); this.reset(); setDefaultDates(); showNotification('æ›åŒ¯ç´€éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
      });
      // è³‡æœ¬è¡¨å–®
      document.getElementById('capitalForm').addEventListener('submit', function(e){
        e.preventDefault();
        const c = { id:Date.now(), date:document.getElementById('capitalDate').value, type:document.getElementById('capitalType').value, amount:parseFloat(document.getElementById('capitalAmount').value), note:document.getElementById('capitalNote').value };
        capitalRecords.push(c); saveLocalData(); updateCapitalTable(); updateCapitalStats(); updateAnalysis(); this.reset(); setDefaultDates(); showNotification('è³‡æœ¬ç´€éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
      });
      // å®šå­˜è¡¨å–®
      document.getElementById('depositForm').addEventListener('submit', function(e){
        e.preventDefault();
        const d = {
          id:Date.now(), startDate:document.getElementById('depositStartDate').value, endDate:document.getElementById('depositEndDate').value,
          bank:document.getElementById('depositBank').value, type:document.getElementById('depositType').value, currency:document.getElementById('depositCurrency').value,
          principal:parseFloat(document.getElementById('depositPrincipal').value), rate:parseFloat(document.getElementById('depositRate').value),
          term:parseInt(document.getElementById('depositTerm').value)||0, interestType:document.getElementById('depositInterestType').value,
          interest:parseFloat(document.getElementById('depositInterest').value)||0, maturityAmount:parseFloat(document.getElementById('depositMaturityAmount').value)||0,
          note:document.getElementById('depositNote').value
        };
        deposits.push(d); saveLocalData(); updateDepositTable(); updateDepositStats(); this.reset(); setDefaultDates(); showNotification('å®šå­˜è¨˜éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
      });
      // å¿«é€Ÿè³£å‡º
      document.getElementById('sellForm').addEventListener('submit', function(e){
        e.preventDefault(); if(!currentSellStock) return;
        const q = parseFloat(document.getElementById('sellQuantity').value);
        const p = parseFloat(document.getElementById('sellPrice').value);
        const dt = document.getElementById('sellDate').value;
        const note = document.getElementById('sellNote').value;
        if (q > currentSellStock.availableQuantity) return showNotification('è³£å‡ºæ•¸é‡ä¸èƒ½è¶…éæŒæœ‰æ•¸é‡','error');
        const tx = { id:Date.now(), date:dt, market:currentSellStock.market, symbol:currentSellStock.symbol, name:currentSellStock.name, type:'è³£å‡º', quantity:q, price:p, isOddLot:false, fee:0, tax:0, note };
        const amt = q*p;
        if (currentSellStock.market==='TW'){ const rate=feeSettings.tw.feeRate/100; tx.fee=Math.max(amt*rate, feeSettings.tw.minFee); tx.tax=amt*(feeSettings.tw.taxRate/100); }
        else if (currentSellStock.market==='US'){ tx.fee = (feeSettings.us.feeType==='fixed') ? feeSettings.us.fixedFee : Math.max(amt*(feeSettings.us.feeRate/100), feeSettings.us.minFee); }
        tx.totalAmount = amt - tx.fee - tx.tax;
        transactions.push(tx); saveLocalData(); updateTransactionTable(); updatePortfolio(); updateAnalysis(); closeSellModal(); showNotification(`æˆåŠŸè³£å‡º ${q} è‚¡ ${currentSellStock.symbol}ï¼`,'success');
      });
    }

    // =========================
    // åˆå§‹åŒ–
    // =========================
    window.addEventListener('load', ()=>{
      // åˆå§‹åŒ– Firebaseï¼ˆä¿®å¾© createUserWithEmailAndPassword æœªå®šç¾©å•é¡Œï¼‰
      FB.init();
      updateSyncStatus('é›¢ç·šæ¨¡å¼', false);
      if (FB.ready){
        try{
          FB.onAuth((user)=>{
            const signedIn = !!user;
            updateSyncStatus(signedIn ? 'ç™»å…¥ç‹€æ…‹ï¼šç·šä¸Š' : 'é›¢ç·šæ¨¡å¼', signedIn);
            if (signedIn) loadUserData();
          });
        }catch(e){ console.warn('Firebaseèªè­‰ç›£è½è¨­å®šå¤±æ•—:', e); }
      }
      // è¼‰å…¥æœ¬åœ°è³‡æ–™èˆ‡ UI
      loadLocalData();
      setDefaultDates();
      bindFormEvents();
      initializeFormEvents();
      updateAnalysis();
      loadAppSettingsUI();
      // è‹¥å·²å¡«å¸‚å ´èˆ‡ä»£è™Ÿï¼Œå˜—è©¦æŸ¥åƒ¹
      setTimeout(()=>{ const m=document.getElementById('market').value, s=document.getElementById('symbol').value; if(m&&s) peekQuote(); },100);
      showNotification('ç³»çµ±å·²å®Œæˆè¼‰å…¥','success');
    });
  </script>
</body>
</html>
