<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Microsoft JhengHei', Arial, sans-serif; }
    body { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); min-height:100vh; padding:20px; }
    .container { max-width:1400px; margin:0 auto; background:white; border-radius:20px; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
    .header { background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); padding:30px; text-align:center; color:white; position:relative; }
    .header h1 { font-size:2.2em; font-weight:600; margin-bottom:8px; letter-spacing:.5px; }
    .header p { opacity:.9; }
    .sync-status { position:absolute; top:20px; right:20px; padding:8px 15px; border-radius:20px; font-size:12px; font-weight:600; background:rgba(255,255,255,.2); backdrop-filter:blur(10px); }
    .sync-status.online { background:rgba(40,167,69,.8); }
    .sync-status.offline { background:rgba(220,53,69,.8); }
    .auth-section { background:rgba(255,255,255,.1); padding:15px; margin-top:15px; border-radius:10px; backdrop-filter:blur(10px); }
    .auth-form { display:flex; gap:10px; align-items:center; flex-wrap:wrap; justify-content:center; }
    .auth-form input { padding:10px 12px; border:none; border-radius:8px; font-size:14px; }
    .auth-form button { padding:10px 15px; border:none; border-radius:8px; background:rgba(255,255,255,.95); color:#333; cursor:pointer; font-weight:700; }
    .tabs { position:sticky; top:0; z-index:50; display:flex; background:#f8f9fa; border-bottom:1px solid #e9ecef; flex-wrap:wrap; }
    .tab { flex:1; min-width:120px; padding:14px 10px; background:none; border:none; cursor:pointer; font-size:14px; font-weight:600; transition:all .2s ease; border-bottom:3px solid transparent; }
    .tab.active { background:white; border-bottom-color:#4facfe; color:#4facfe; }
    .tab:hover { background:#eef2f7; }
    .content { display:none; padding:26px; }
    .content.active { display:block; }
    .form-section { background:#f8f9fa; border-radius:15px; padding:22px; margin-bottom:24px; box-shadow:0 5px 15px rgba(0,0,0,.05); }
    .form-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:14px; margin-bottom:16px; }
    .form-group { display:flex; flex-direction:column; }
    .form-group label { font-weight:700; margin-bottom:6px; color:#2f3640; }
    .form-group input, .form-group select { padding:12px; border:2px solid #e9ecef; border-radius:10px; font-size:14px; transition:border-color .2s ease; background:#fff; }
    .form-group input:focus, .form-group select:focus { outline:none; border-color:#4facfe; }
    .btn { background:linear-gradient(135deg,#4facfe 0%,#00f2fe 100%); color:white; border:none; padding:13px 22px; border-radius:10px; font-size:15px; font-weight:800; cursor:pointer; transition:transform .15s ease; margin:5px; }
    .btn:hover { transform:translateY(-1px); box-shadow:0 6px 16px rgba(79,172,254,.35); }
    .btn:disabled { opacity:.6; cursor:not-allowed; transform:none; }
    .btn-danger { background:linear-gradient(135deg,#ff6b6b 0%,#ee5a52 100%); }
    .btn-exchange { background:linear-gradient(135deg,#ffa726 0%,#ff7043 100%); }
    .btn-sync { background:linear-gradient(135deg,#28a745 0%,#20c997 100%); }
    .btn-sell { background:linear-gradient(135deg,#e74c3c 0%,#c0392b 100%); padding:8px 15px; font-size:12px; }
    .btn-neutral { background:#6c757d; }
    .btn-light { background:#e9ecef; color:#333; }
    .btn-chip { background:#eef2f7; color:#2f3640; border:none; padding:8px 10px; border-radius:8px; font-size:12px; cursor:pointer; }
    .btn-chip:hover { opacity:.9; }
    .table-container { background:white; border-radius:15px; overflow:hidden; box-shadow:0 5px 15px rgba(0,0,0,.05); margin-top:14px; overflow-x:auto; }
    table { width:100%; border-collapse:collapse; min-width:900px; }
    th { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:13px 10px; font-weight:800; text-align:center; font-size:13px; }
    td { padding:11px 10px; text-align:center; border-bottom:1px solid #e9ecef; font-size:13px; }
    tr:hover { background:#f8f9fa; }
    .profit { color:#28a745; font-weight:800; }
    .loss { color:#dc3545; font-weight:800; }
    .stats-grid { display:grid; grid-template-columns:repeat(auto-fit,minmax(240px,1fr)); gap:16px; margin-bottom:22px; }
    .stat-card { background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; padding:20px; border-radius:15px; text-align:center; box-shadow:0 10px 25px rgba(102,126,234,.28); }
    .capital-card { background:linear-gradient(135deg,#2ecc71 0%,#27ae60 100%); color:white; padding:20px; border-radius:15px; text-align:center; box-shadow:0 10px 25px rgba(46,204,113,.28); }
    .stat-value { font-size:1.8em; font-weight:900; margin-bottom:6px; }
    .stat-label { font-size:1em; opacity:.9; }
    .delete-btn { background:#dc3545; color:white; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; font-size:12px; }
    .delete-btn:hover { background:#c82333; }
    .fee-info { background:#e8f4fd; padding:12px; border-radius:10px; margin-bottom:12px; border-left:4px solid #4facfe; text-align:left; }
    .fee-info h4 { color:#0066cc; margin-bottom:6px; }
    .fee-info p { margin:2px 0; color:#495057; }
    .market-indicator { display:inline-block; padding:3px 8px; border-radius:12px; font-size:11px; font-weight:800; color:white; }
    .market-tw { background:#28a745; }
    .market-us { background:#007bff; }
    .exchange-card { background:linear-gradient(135deg,#ffa726 0%,#ff7043 100%); color:white; padding:20px; border-radius:15px; text-align:center; box-shadow:0 10px 25px rgba(255,167,38,.28); }
    .loading { display:inline-block; width:20px; height:20px; border:3px solid rgba(255,255,255,.3); border-radius:50%; border-top-color:#fff; animation:spin 1s ease-in-out infinite; }
    @keyframes spin { to { transform:rotate(360deg); } }
    .notification { position:fixed; top:20px; right:20px; padding:14px 16px; border-radius:10px; color:white; font-weight:800; z-index:1000; transform:translateX(100%); transition:transform .25s ease; }
    .notification.show { transform:translateX(0); }
    .notification.success { background:#28a745; }
    .notification.error { background:#dc3545; }
    .modal { display:none; position:fixed; z-index:2000; left:0; top:0; width:100%; height:100%; background-color:rgba(0,0,0,.5); }
    .modal-content { background-color:white; margin:5% auto; padding:24px; border-radius:15px; width:90%; max-width:520px; box-shadow:0 20px 40px rgba(0,0,0,.3); }
    .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; padding-bottom:12px; border-bottom:1px solid #e9ecef; }
    .modal-header h3 { color:#495057; }
    .close { color:#aaa; font-size:26px; font-weight:900; cursor:pointer; }
    .close:hover { color:#333; }
    /* å¤šå¸³æˆ¶ UI */
    .account-switcher { margin-top:12px; display:flex; flex-direction:column; align-items:center; gap:6px; }
    .account-row { display:flex; gap:8px; flex-wrap:wrap; justify-content:center; }
    #accountSelect { padding:8px 12px; border-radius:8px; border:2px solid #e9ecef; font-size:14px; background:#fff; }
    .btn-sm { padding:8px 12px; font-size:12px; border-radius:8px; border:none; cursor:pointer; }
    .btn-sm:hover { opacity:.9; }
    /* æ›´äººæ€§åŒ–ï¼šæ¬„ä½å°å·¥å…· */
    .input-with-btn { display:flex; gap:8px; align-items:center; }
    .hint { color:#555; margin-top:6px; min-height:18px; display:block; font-size:12px; text-align:left; }
    .api-status { margin-top:10px; padding:8px 12px; border-radius:8px; font-size:12px; font-weight:600; }
    .api-status.success { background:#d4edda; color:#155724; }
    .api-status.warning { background:#fff3cd; color:#856404; }
    .api-status.error { background:#f8d7da; color:#721c24; }
    @media (max-width:768px){
      .container { margin:10px; border-radius:10px; }
      .header { padding:20px; }
      .header h1 { font-size:1.6em; }
      .content { padding:18px; }
      .form-grid { grid-template-columns:1fr; }
      .stats-grid { grid-template-columns:1fr; }
      table { font-size:12px; }
      th, td { padding:8px 5px; }
      .tab { font-size:12px; padding:12px 8px; }
      .sync-status { position:static; display:inline-block; margin-top:10px; }
      .auth-form { flex-direction:column; align-items:stretch; }
      .auth-form input, .auth-form button { width:100%; margin:5px 0; }
      .modal-content { margin:10% auto; width:95%; padding:20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="sync-status" id="syncStatus">
        <span class="loading" id="loadingSpinner" style="display:none;"></span>
        <span id="statusText">é›¢ç·šæ¨¡å¼</span>
      </div>
      <h1>ğŸ“ˆ è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±</h1>
      <p>å¤šå¸³æˆ¶ï½œå°/ç¾è‚¡è¨˜éŒ„èˆ‡ç¸¾æ•ˆåˆ†æï½œçµ±ä¸€å ±åƒ¹APIï½œé›²ç«¯åŒæ­¥</p>

      <div class="auth-section" id="authSection">
        <div class="auth-form">
          <input type="email" id="userEmail" placeholder="é›»å­éƒµä»¶">
          <input type="password" id="userPassword" placeholder="å¯†ç¢¼">
          <button onclick="signIn()">ç™»å…¥</button>
          <button onclick="signUp()">è¨»å†Š</button>
          <button onclick="signOut()" id="signOutBtn" style="display:none;">ç™»å‡º</button>
        </div>
        <p style="font-size:12px; margin-top:10px; opacity:.8;">æœ¬åœ°æ¨¡å¼å¯å®Œæ•´ä½¿ç”¨æ‰€æœ‰åŠŸèƒ½ï¼Œé›²ç«¯åŒæ­¥éœ€é…ç½®Firebase</p>
        <div id="firebaseStatus" class="api-status warning">Firebase: æœªé…ç½® (åƒ…æœ¬åœ°æ¨¡å¼)</div>
      </div>

      <!-- å¤šå¸³æˆ¶ï¼šå¸³æˆ¶åˆ‡æ›å™¨ -->
      <div class="account-switcher">
        <div class="account-row">
          <select id="accountSelect" onchange="onAccountChange(this.value)"></select>
          <button class="btn-sm btn-light" onclick="createAccount()">æ–°å¢å¸³æˆ¶</button>
          <button class="btn-sm btn-light" onclick="renameAccount()">é‡æ–°å‘½å</button>
          <button class="btn-sm btn-danger" onclick="removeAccount()">åˆªé™¤å¸³æˆ¶</button>
        </div>
        <small id="accountMeta" style="opacity:.85;"></small>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" onclick="switchTab('transaction')">äº¤æ˜“ç´€éŒ„</button>
      <button class="tab" onclick="switchTab('exchange')">æ›åŒ¯ç´€éŒ„</button>
      <button class="tab" onclick="switchTab('portfolio')">æŒå€‰æ˜ç´°</button>
      <button class="tab" onclick="switchTab('capital')">è³‡æœ¬ç®¡ç†</button>
      <button class="tab" onclick="switchTab('analysis')">ç¸¾æ•ˆåˆ†æ</button>
      <button class="tab" onclick="switchTab('settings')">è²»ç‡/å ±åƒ¹è¨­å®š</button>
      <button class="tab" onclick="switchTab('export')">åŒ¯å‡ºåŠŸèƒ½</button>
    </div>

    <!-- äº¤æ˜“ç´€éŒ„ -->
    <div id="transaction" class="content active">
      <div class="fee-info">
        <h4>ğŸ’¡ æ‰‹çºŒè²»è‡ªå‹•è¨ˆç®—èªªæ˜</h4>
        <p><strong>å°è‚¡ï¼š</strong>æ‰‹çºŒè²» 0.1425%ï¼Œæ•´è‚¡æœ€ä½20å…ƒï¼Œé›¶è‚¡æœ€ä½1å…ƒ | äº¤æ˜“ç¨…ï¼šè³£å‡ºæ™‚æ”¶å– 0.3%</p>
        <p><strong>ç¾è‚¡ï¼š</strong>ä¾åˆ¸å•†è¨­å®šè¨ˆç®—ï¼Œå¯åœ¨ã€Œè²»ç‡/å ±åƒ¹è¨­å®šã€ä¸­èª¿æ•´</p>
        <button class="btn btn-sync" onclick="syncData()" id="syncBtn" disabled>
          <span id="syncBtnText">ğŸ”„ åŒæ­¥è³‡æ–™</span>
        </button>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ“ æ–°å¢äº¤æ˜“ç´€éŒ„</h3>
        <form id="transactionForm">
          <div class="form-grid">
            <div class="form-group">
              <label>æ—¥æœŸ</label>
              <input type="date" id="date" required>
            </div>
            <div class="form-group">
              <label>å¸‚å ´</label>
              <select id="market" required>
                <option value="">é¸æ“‡å¸‚å ´</option>
                <option value="TW">å°è‚¡ ğŸ‡¹ğŸ‡¼</option>
                <option value="US">ç¾è‚¡ ğŸ‡ºğŸ‡¸</option>
              </select>
            </div>
            <div class="form-group">
              <label>è‚¡ç¥¨ä»£è™Ÿ</label>
              <div class="input-with-btn">
                <input type="text" id="symbol" placeholder="ä¾‹: 2330, AAPL" required>
                <button type="button" class="btn-chip" onclick="peekQuote()">ğŸ” æŸ¥åƒ¹</button>
              </div>
              <small id="lastQuoteHint" class="hint"></small>
            </div>
            <div class="form-group">
              <label>è‚¡ç¥¨åç¨±</label>
              <input type="text" id="name" placeholder="ä¾‹: å°ç©é›», Apple Inc." required>
            </div>
            <div class="form-group">
              <label>äº¤æ˜“é¡å‹</label>
              <select id="type" required>
                <option value="">é¸æ“‡é¡å‹</option>
                <option value="è²·é€²">è²·é€²</option>
                <option value="è³£å‡º">è³£å‡º</option>
              </select>
            </div>
            <div class="form-group">
              <label>æ•¸é‡</label>
              <input type="number" id="quantity" placeholder="è‚¡æ•¸" required>
            </div>
            <div class="form-group">
              <label>åƒ¹æ ¼</label>
              <div class="input-with-btn">
                <input type="number" id="price" step="0.01" placeholder="æ¯è‚¡åƒ¹æ ¼" required>
                <button type="button" class="btn-chip" onclick="fillCurrentPrice()">â†˜ ç¾åƒ¹å¡«å…¥</button>
              </div>
            </div>
            <div class="form-group">
              <label>æ˜¯å¦ç‚ºé›¶è‚¡ (å°è‚¡)</label>
              <select id="oddLot">
                <option value="false">æ•´è‚¡äº¤æ˜“</option>
                <option value="true">é›¶è‚¡äº¤æ˜“</option>
              </select>
            </div>
            <div class="form-group">
              <label>æ‰‹çºŒè²»</label>
              <input type="number" id="fee" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
            </div>
            <div class="form-group">
              <label>äº¤æ˜“ç¨…</label>
              <input type="number" id="tax" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
            </div>
            <div class="form-group">
              <label>å‚™è¨»</label>
              <input type="text" id="note" placeholder="é¸å¡«">
            </div>
          </div>
          <button type="button" onclick="calculateFees()" class="btn btn-neutral">ğŸ§® é‡æ–°è¨ˆç®—è²»ç”¨</button>
          <button type="submit" class="btn">â• æ–°å¢äº¤æ˜“</button>
        </form>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>å¸‚å ´</th><th>ä»£è™Ÿ</th><th>åç¨±</th>
            <th>é¡å‹</th><th>æ•¸é‡</th><th>åƒ¹æ ¼</th><th>é›¶è‚¡</th>
            <th>æ‰‹çºŒè²»</th><th>äº¤æ˜“ç¨…</th><th>ç¸½é‡‘é¡</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="transactionTable"></tbody>
        </table>
      </div>
    </div>

    <!-- æ›åŒ¯ç´€éŒ„ -->
    <div id="exchange" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ’± æ–°å¢æ›åŒ¯ç´€éŒ„</h3>
        <form id="exchangeForm">
          <div class="form-grid">
            <div class="form-group">
              <label>æ—¥æœŸ</label>
              <input type="date" id="exchangeDate" required>
            </div>
            <div class="form-group">
              <label>å…Œæ›é¡å‹</label>
              <select id="exchangeType" required>
                <option value="">é¸æ“‡å…Œæ›</option>
                <option value="TWD-USD">å°å¹£ â†’ ç¾å…ƒ</option>
                <option value="USD-TWD">ç¾å…ƒ â†’ å°å¹£</option>
                <option value="TWD-CNY">å°å¹£ â†’ äººæ°‘å¹£</option>
                <option value="CNY-TWD">äººæ°‘å¹£ â†’ å°å¹£</option>
                <option value="USD-CNY">ç¾å…ƒ â†’ äººæ°‘å¹£</option>
                <option value="CNY-USD">äººæ°‘å¹£ â†’ ç¾å…ƒ</option>
              </select>
            </div>
            <div class="form-group">
              <label>å…Œå‡ºé‡‘é¡</label>
              <input type="number" id="fromAmount" step="0.01" placeholder="å…Œå‡ºé‡‘é¡" required>
            </div>
            <div class="form-group">
              <label>åŒ¯ç‡</label>
              <input type="number" id="exchangeRate" step="0.0001" placeholder="åŒ¯ç‡" required>
            </div>
            <div class="form-group">
              <label>å…Œå…¥é‡‘é¡</label>
              <div class="input-with-btn">
                <input type="number" id="toAmount" step="0.01" placeholder="è‡ªå‹•è¨ˆç®—" readonly>
                <button type="button" class="btn-chip" onclick="calculateExchangeAmount()">â†» è¨ˆç®—</button>
              </div>
            </div>
            <div class="form-group">
              <label>æ‰‹çºŒè²»</label>
              <input type="number" id="exchangeFee" step="0.01" placeholder="æ›åŒ¯æ‰‹çºŒè²»" value="0">
            </div>
            <div class="form-group">
              <label>éŠ€è¡Œ/åˆ¸å•†</label>
              <input type="text" id="exchangeBank" placeholder="ä¾‹: å°éŠ€, å¯Œé‚¦">
            </div>
            <div class="form-group">
              <label>å‚™è¨»</label>
              <input type="text" id="exchangeNote" placeholder="é¸å¡«">
            </div>
          </div>
          <button type="submit" class="btn btn-exchange">ğŸ’± æ–°å¢æ›åŒ¯ç´€éŒ„</button>
        </form>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>å…Œæ›é¡å‹</th><th>å…Œå‡ºé‡‘é¡</th><th>åŒ¯ç‡</th><th>å…Œå…¥é‡‘é¡</th>
            <th>æ‰‹çºŒè²»</th><th>éŠ€è¡Œ/åˆ¸å•†</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="exchangeTable"></tbody>
        </table>
      </div>
    </div>

    <!-- æŒå€‰æ˜ç´° -->
    <div id="portfolio" class="content">
      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>å¸‚å ´</th><th>ä»£è™Ÿ</th><th>åç¨±</th><th>æŒæœ‰è‚¡æ•¸</th>
            <th>å¹³å‡æˆæœ¬</th><th>ç¸½æˆæœ¬</th><th>ç¾åƒ¹</th><th>å¸‚å€¼</th>
            <th>æœªå¯¦ç¾æç›Š</th><th>å ±é…¬ç‡(%)</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="portfolioTable"></tbody>
        </table>
      </div>
    </div>

    <!-- è³‡æœ¬ç®¡ç† -->
    <div id="capital" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ’° è³‡æœ¬ç®¡ç†</h3>
        <form id="capitalForm">
          <div class="form-grid">
            <div class="form-group">
              <label>æ—¥æœŸ</label>
              <input type="date" id="capitalDate" required>
            </div>
            <div class="form-group">
              <label>é¡å‹</label>
              <select id="capitalType" required>
                <option value="">é¸æ“‡é¡å‹</option>
                <option value="åˆå§‹æŠ•å…¥">åˆå§‹æŠ•å…¥</option>
                <option value="è¿½åŠ æŠ•å…¥">è¿½åŠ æŠ•å…¥</option>
                <option value="è³‡é‡‘æå–">è³‡é‡‘æå–</option>
              </select>
            </div>
            <div class="form-group">
              <label>é‡‘é¡</label>
              <input type="number" id="capitalAmount" step="0.01" placeholder="æŠ•å…¥/æå–é‡‘é¡" required>
            </div>
            <div class="form-group">
              <label>å‚™è¨»</label>
              <input type="text" id="capitalNote" placeholder="é¸å¡«">
            </div>
          </div>
          <button type="submit" class="btn">ğŸ’° æ–°å¢è³‡æœ¬ç´€éŒ„</button>
        </form>
      </div>

      <div class="stats-grid">
        <div class="capital-card">
          <div class="stat-value" id="totalCapital">$0</div>
          <div class="stat-label">ç¸½æŠ•å…¥è³‡æœ¬</div>
        </div>
        <div class="capital-card">
          <div class="stat-value" id="availableCapital">$0</div>
          <div class="stat-label">å¯ç”¨è³‡é‡‘</div>
        </div>
        <div class="capital-card">
          <div class="stat-value" id="investedCapital">$0</div>
          <div class="stat-label">å·²æŠ•è³‡é‡‘é¡</div>
        </div>
      </div>

      <div class="table-container">
        <table>
          <thead>
          <tr>
            <th>æ—¥æœŸ</th><th>é¡å‹</th><th>é‡‘é¡</th><th>ç´¯è¨ˆè³‡æœ¬</th><th>å‚™è¨»</th><th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody id="capitalTable"></tbody>
        </table>
      </div>
    </div>

    <!-- ç¸¾æ•ˆåˆ†æ -->
    <div id="analysis" class="content">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-value" id="totalInvestment">$0</div>
          <div class="stat-label">ç¸½æŠ•å…¥é‡‘é¡</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalValue">$0</div>
          <div class="stat-label">ç¸½å¸‚å€¼</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalProfit">$0</div>
          <div class="stat-label">ç¸½æç›Š</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="totalReturn">0%</div>
          <div class="stat-label">ç¸½å ±é…¬ç‡</div>
        </div>
        <div class="exchange-card">
          <div class="stat-value" id="totalExchangeFee">$0</div>
          <div class="stat-label">ç¸½æ›åŒ¯è²»ç”¨</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="realizedProfitTotal">$0</div>
          <div class="stat-label">å·²å¯¦ç¾æç›Šï¼ˆè‚¡ï¼‰</div>
        </div>
        <div class="stat-card">
          <div class="stat-value" id="fxProfitTotal">$0</div>
          <div class="stat-label">æ›åŒ¯æç›Šï¼ˆTWDï¼‰</div>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ“Š å¸‚å ´åˆ†å¸ƒ</h3>
        <div id="marketDistribution"></div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ’µ å€‹è‚¡è³£å‡ºæç›Š</h3>
        <div class="table-container">
          <table>
            <thead>
            <tr>
              <th>æ—¥æœŸ</th><th>å¸‚å ´</th><th>ä»£è™Ÿ</th><th>åç¨±</th>
              <th>è³£å‡ºè‚¡æ•¸</th><th>å¹³å‡æˆæœ¬</th><th>è³£å‡ºæ·¨é¡</th>
              <th>æˆæœ¬</th><th>å·²å¯¦ç¾æç›Š</th><th>å ±é…¬ç‡(%)</th><th>å‚™è¨»</th>
            </tr>
            </thead>
            <tbody id="realizedTable"></tbody>
          </table>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ’± æ›åŒ¯æç›Š</h3>
        <div class="table-container">
          <table>
            <thead>
            <tr>
              <th>æ—¥æœŸ</th><th>å¹£åˆ¥å°</th><th>å‹•ä½œ</th><th>æ•¸é‡</th>
              <th>åŒ¯ç‡</th><th>è²»ç”¨(TWD)</th><th>å·²å¯¦ç¾æç›Š(TWD)</th><th>å‚™è¨»</th>
            </tr>
            </thead>
            <tbody id="fxPnLTable"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- è¨­å®š -->
    <div id="settings" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">âš™ï¸ äº¤æ˜“è²»ç‡è¨­å®š</h3>

        <h4 style="color:#28a745; margin-bottom:10px;">ğŸ‡¹ğŸ‡¼ å°è‚¡è²»ç‡è¨­å®š</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>æ‰‹çºŒè²»ç‡ (%)</label>
            <input type="number" id="twFeeRate" step="0.0001" value="0.1425">
          </div>
          <div class="form-group">
            <label>æ•´è‚¡æœ€ä½æ‰‹çºŒè²»</label>
            <input type="number" id="twMinFee" step="1" value="20">
          </div>
          <div class="form-group">
            <label>é›¶è‚¡æœ€ä½æ‰‹çºŒè²»</label>
            <input type="number" id="twOddLotMinFee" step="1" value="1">
          </div>
          <div class="form-group">
            <label>è­‰äº¤ç¨…ç‡ï¼ˆè³£å‡ºï¼‰%</label>
            <input type="number" id="twTaxRate" step="0.01" value="0.3">
          </div>
        </div>

        <h4 style="color:#007bff; margin:10px 0;">ğŸ‡ºğŸ‡¸ ç¾è‚¡è²»ç‡è¨­å®š</h4>
        <div class="form-grid">
          <div class="form-group">
            <label>æ‰‹çºŒè²»é¡å‹</label>
            <select id="usFeeType">
              <option value="fixed">å›ºå®šé‡‘é¡</option>
              <option value="rate">ç™¾åˆ†æ¯”</option>
            </select>
          </div>
          <div class="form-group">
            <label>å›ºå®šæ‰‹çºŒè²»</label>
            <input type="number" id="usFixedFee" step="0.01" value="0">
          </div>
          <div class="form-group">
            <label>æ‰‹çºŒè²»ç‡ (%)</label>
            <input type="number" id="usFeeRate" step="0.0001" value="0">
          </div>
          <div class="form-group">
            <label>æœ€ä½æ‰‹çºŒè²»</label>
            <input type="number" id="usMinFee" step="0.01" value="0">
          </div>
        </div>

        <div style="margin-top:6px;">
          <button class="btn" onclick="saveFeeSettings()">ğŸ’¾ å„²å­˜è²»ç‡è¨­å®š</button>
          <button class="btn btn-danger" onclick="resetFeeSettings()">â†©ï¸ é‡ç½®ç‚ºé è¨­</button>
        </div>
      </div>

      <!-- å ±åƒ¹è¨­å®š -->
      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ“¡ çµ±ä¸€å ±åƒ¹è¨­å®š</h3>
        <div id="priceApiStatus" class="api-status warning">APIç‹€æ…‹ï¼šæœªæ¸¬è©¦</div>
        <div class="form-grid">
          <div class="form-group">
            <label>ä½¿ç”¨å³æ™‚å ±åƒ¹</label>
            <select id="useLivePrice">
              <option value="true">æ˜¯ï¼ˆé è¨­é–‹å•Ÿï¼‰</option>
              <option value="false">å¦</option>
            </select>
          </div>
          <div class="form-group">
            <label>å ±åƒ¹APIé¸æ“‡</label>
            <select id="priceApiProvider">
              <option value="unified">çµ±ä¸€API (æ¨è–¦)</option>
              <option value="separate">åˆ†é›¢API (åŸæ¨¡å¼)</option>
            </select>
          </div>
          <div class="form-group">
            <label>Alpha Vantage API Key (çµ±ä¸€)</label>
            <input type="text" id="alphaVantageKey" placeholder="å…è²»ç”³è«‹: alphavantage.co">
          </div>
          <div class="form-group">
            <label>Finnhub API Key (ç¾è‚¡)</label>
            <input type="text" id="finnhubKey" placeholder="åƒ…åˆ†é›¢æ¨¡å¼ä½¿ç”¨">
          </div>
        </div>
        <small style="display:block; margin:6px 0; color:#555;">
          <strong>çµ±ä¸€APIï¼š</strong>ä½¿ç”¨Alpha Vantageï¼Œå°è‚¡ã€ç¾è‚¡çš†æ”¯æ´<br>
          <strong>åˆ†é›¢APIï¼š</strong>å°è‚¡ç”¨TWSEï¼Œç¾è‚¡ç”¨Finnhubï¼ˆåŸæ¨¡å¼ï¼‰
        </small>
        <button class="btn" onclick="saveAppSettings()">ğŸ’¾ å„²å­˜å ±åƒ¹è¨­å®š</button>
        <button class="btn btn-neutral" onclick="testApiConnection()">ğŸ” æ¸¬è©¦APIé€£ç·š</button>
      </div>

      <!-- Firebase è¨­å®š -->
      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">â˜ï¸ Firebase é›²ç«¯åŒæ­¥è¨­å®š</h3>
        <div class="form-grid">
          <div class="form-group">
            <label>Firebase Config (JSON)</label>
            <textarea id="firebaseConfig" rows="4" placeholder='{"apiKey":"your-key","authDomain":"...","databaseURL":"...","projectId":"..."}'></textarea>
          </div>
        </div>
        <small style="display:block; margin:6px 0; color:#555;">
          è«‹åˆ° Firebase Console å»ºç«‹å°ˆæ¡ˆï¼Œå•Ÿç”¨ Authentication å’Œ Realtime Databaseï¼Œä¸¦è²¼ä¸Šè¨­å®šæª”æ¡ˆ
        </small>
        <button class="btn" onclick="saveFirebaseConfig()">ğŸ’¾ å„²å­˜Firebaseè¨­å®š</button>
        <button class="btn btn-neutral" onclick="initializeFirebase()">ğŸ”„ é‡æ–°åˆå§‹åŒ–</button>
      </div>
    </div>

    <!-- åŒ¯å‡ºåŠŸèƒ½ -->
    <div id="export" class="content">
      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ“¤ åŒ¯å‡ºåŠŸèƒ½</h3>
        <div class="account-row" style="justify-content:flex-start;">
          <button class="btn btn-light" onclick="exportToCSV('transactions')">åŒ¯å‡ºäº¤æ˜“ç´€éŒ„ CSV</button>
          <button class="btn btn-light" onclick="exportToCSV('exchange')">åŒ¯å‡ºæ›åŒ¯ç´€éŒ„ CSV</button>
          <button class="btn btn-light" onclick="exportToCSV('capital')">åŒ¯å‡ºè³‡æœ¬ç´€éŒ„ CSV</button>
          <button class="btn" onclick="exportAllData()">ğŸ’¾ åŒ¯å‡ºå®Œæ•´å‚™ä»½ï¼ˆJSONï¼‰</button>
          <button class="btn btn-danger" onclick="clearAllData()">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        </div>
      </div>

      <div class="form-section">
        <h3 style="margin-bottom:14px; color:#495057;">ğŸ“¥ åŒ¯å…¥åŠŸèƒ½</h3>
        <div class="form-group">
          <label>åŒ¯å…¥å‚™ä»½æª”æ¡ˆ (JSON)</label>
          <input type="file" id="importFile" accept=".json" onchange="importData(this)">
        </div>
        <small style="display:block; margin:6px 0; color:#555;">
          æ”¯æ´åŒ¯å…¥æœ¬ç³»çµ±åŒ¯å‡ºçš„JSONå‚™ä»½æª”æ¡ˆ
        </small>
      </div>
    </div>
  </div>

  <!-- å¿«é€Ÿè³£å‡º Modal -->
  <div id="sellModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3>å¿«é€Ÿè³£å‡º</h3>
        <span class="close" onclick="closeSellModal()">&times;</span>
      </div>
      <form id="sellForm">
        <div class="form-grid">
          <div class="form-group">
            <label>è‚¡ç¥¨</label>
            <input type="text" id="sellStockInfo" readonly>
          </div>
          <div class="form-group">
            <label>å¯è³£è‚¡æ•¸</label>
            <input type="number" id="sellAvailableQuantity" readonly>
          </div>
          <div class="form-group">
            <label>è³£å‡ºè‚¡æ•¸</label>
            <input type="number" id="sellQuantity" required min="1">
          </div>
          <div class="form-group">
            <label>è³£å‡ºåƒ¹æ ¼</label>
            <input type="number" id="sellPrice" step="0.01" required>
          </div>
          <div class="form-group">
            <label>æ—¥æœŸ</label>
            <input type="date" id="sellDate" required>
          </div>
          <div class="form-group">
            <label>å‚™è¨»</label>
            <input type="text" id="sellNote" placeholder="é¸å¡«">
          </div>
        </div>
        <div style="text-align:right;">
          <button type="button" class="btn btn-light" onclick="closeSellModal()">å–æ¶ˆ</button>
          <button type="submit" class="btn btn-sell">ğŸ’¸ ç¢ºèªè³£å‡º</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // =========================
    // å…¨åŸŸè®Šæ•¸
    // =========================
    let transactions = [];
    let exchanges = [];
    let capitalRecords = [];
    let feeSettings = {
      tw: { feeRate: 0.1425, minFee: 20, oddLotMinFee: 1, taxRate: 0.3 },
      us: { feeType: 'fixed', fixedFee: 0, feeRate: 0, minFee: 0 }
    };
    let currentPrices = {}; // { key: { value, _ts } }
    let currentSellStock = null;
    let lastPeekPrice = null;

    // å¤šå¸³æˆ¶
    let accounts = {};
    let currentAccountId = null;
    function _genAccId(){ return 'acc_' + Math.random().toString(36).slice(2,10); }

    // å ±åƒ¹è¨­å®š
    let appSettings = JSON.parse(localStorage.getItem('appSettings') || '{}');
    if (!appSettings || typeof appSettings !== 'object') appSettings = {};
    if (appSettings.useLivePrice === undefined) appSettings.useLivePrice = true;
    if (!appSettings.priceApiProvider) appSettings.priceApiProvider = 'unified';
    if (!appSettings.alphaVantageKey) appSettings.alphaVantageKey = '';
    if (!appSettings.finnhubKey) appSettings.finnhubKey = 'd30rabhr01qnu2qvafv0d30rabhr01qnu2qvafvg';

    // Firebaseè¨­å®š
    let firebaseConfig = JSON.parse(localStorage.getItem('firebaseConfig') || 'null');
    let firebaseApp = null;

    // =========================
    // Firebase ç›¸å®¹å±¤
    // =========================
    const FB = {
      ready:false, _auth:null, _db:null,
      init() {
        try {
          if (firebaseConfig && window.firebase) {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            this._auth = firebase.auth();
            this._db = firebase.database();
            this.ready = true;
            updateFirebaseStatus('Firebase: å·²é€£ç·š', 'success');
          } else {
            this.ready = false;
            updateFirebaseStatus('Firebase: æœªé…ç½® (åƒ…æœ¬åœ°æ¨¡å¼)', 'warning');
          }
        } catch(e){ 
          this.ready = false; 
          updateFirebaseStatus('Firebase: é…ç½®éŒ¯èª¤', 'error');
          console.error('Firebaseåˆå§‹åŒ–å¤±æ•—:', e);
        }
      },
      currentUser(){ return this._auth && this._auth.currentUser ? this._auth.currentUser : null; },
      async createUser(email, pw){
        if (!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–ï¼Œè«‹å…ˆåœ¨è¨­å®šä¸­é…ç½®');
        return this._auth.createUserWithEmailAndPassword(email, pw);
      },
      async signIn(email, pw){
        if (!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–ï¼Œè«‹å…ˆåœ¨è¨­å®šä¸­é…ç½®');
        return this._auth.signInWithEmailAndPassword(email, pw);
      },
      async signOut(){
        if (!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–');
        return this._auth.signOut();
      },
      onAuth(cb){
        if (!this.ready) return;
        this._auth.onAuthStateChanged(cb);
      },
      async set(path, data){
        if (!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–');
        return this._db.ref(path).set(data);
      },
      async get(path){
        if (!this.ready) throw new Error('Firebase æœªåˆå§‹åŒ–');
        const ref = this._db.ref(path);
        const snap = await ref.once('value');
        return {
          exists: () => snap.exists(),
          val: () => snap.val()
        };
      }
    };

    function updateFirebaseStatus(text, type) {
      const el = document.getElementById('firebaseStatus');
      if (el) {
        el.textContent = text;
        el.className = `api-status ${type}`;
      }
    }

    // =========================
    // èªè­‰èˆ‡åŒæ­¥
    // =========================
    async function signUp() {
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;
      if (!email || !password) { showNotification('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼','error'); return; }
      try {
        showLoading(true);
        await FB.createUser(email, password);
        showNotification('è¨»å†ŠæˆåŠŸï¼','success');
        document.getElementById('userEmail').value=''; 
        document.getElementById('userPassword').value='';
        document.getElementById('syncBtn').disabled = false;
        updateSyncStatus('ç™»å…¥ç‹€æ…‹ï¼šç·šä¸Š', true);
      } catch (e){ showNotification('è¨»å†Šå¤±æ•—: ' + e.message,'error'); }
      finally { showLoading(false); }
    }

    async function signIn() {
      const email = document.getElementById('userEmail').value;
      const password = document.getElementById('userPassword').value;
      if (!email || !password) { showNotification('è«‹è¼¸å…¥é›»å­éƒµä»¶å’Œå¯†ç¢¼','error'); return; }
      try {
        showLoading(true);
        await FB.signIn(email, password);
        showNotification('ç™»å…¥æˆåŠŸï¼','success');
        document.getElementById('userEmail').value=''; 
        document.getElementById('userPassword').value='';
        document.getElementById('syncBtn').disabled = false;
        updateSyncStatus('ç™»å…¥ç‹€æ…‹ï¼šç·šä¸Š', true);
        await loadUserData();
      } catch (e){ showNotification('ç™»å…¥å¤±æ•—: ' + e.message,'error'); }
      finally { showLoading(false); }
    }

    async function signOut() {
      try {
        if (!FB.ready) { showNotification('ç›®å‰ç‚ºæœ¬åœ°æ¨¡å¼ï¼Œç„¡éœ€ç™»å‡º','error'); return; }
        await FB.signOut();
        showNotification('å·²ç™»å‡º','success');
        document.getElementById('syncBtn').disabled = true;
        updateSyncStatus('é›¢ç·šæ¨¡å¼', false);
      } catch (e){ showNotification('ç™»å‡ºå¤±æ•—: ' + e.message,'error'); }
    }

    async function syncData() {
      if (!FB.ready || !FB.currentUser()) { showNotification('è«‹å…ˆç™»å…¥','error'); return; }
      try {
        showLoading(true);
        const userId = FB.currentUser().uid;
        flushWorkingSetsToAccount();
        const payload = {
          accounts: accounts,
          selectedAccountId: currentAccountId,
          lastSync: new Date().toISOString(),
          version: '2.0.0'
        };
        await FB.set(`users/${userId}`, payload);
        showNotification('è³‡æ–™åŒæ­¥æˆåŠŸï¼','success');
      } catch (e){ showNotification('åŒæ­¥å¤±æ•—: ' + e.message,'error'); }
      finally { showLoading(false); }
    }

    async function loadUserData() {
      if (!FB.ready || !FB.currentUser()) return;
      try {
        showLoading(true);
        const userId = FB.currentUser().uid;
        const snapshot = await FB.get(`users/${userId}`);
        if (snapshot && snapshot.exists()) {
          const userData = snapshot.val();
          if (userData.accounts) {
            accounts = userData.accounts || {};
            currentAccountId = userData.selectedAccountId || Object.keys(accounts)[0];
            refreshAccountSelect(); hydrateFromAccount();
            showNotification('è³‡æ–™è¼‰å…¥æˆåŠŸ','success');
          } else {
            const acc = createEmptyAccount('é›²ç«¯åŒ¯å…¥','ç¾è‚¡','TWD');
            acc.transactions   = userData.transactions || [];
            acc.exchanges      = userData.exchanges || [];
            acc.capitalRecords = userData.capitalRecords || [];
            acc.feeSettings    = userData.feeSettings || feeSettings;
            accounts = { [acc.id]: acc };
            currentAccountId = acc.id;
            refreshAccountSelect(); hydrateFromAccount();
            showNotification('å·²å¾èˆŠç‰ˆæ ¼å¼è¼‰å…¥ä¸¦å‡ç´šç‚ºå¸³æˆ¶åˆ¶','success');
          }
        }
      } catch (e){
        showNotification('è¼‰å…¥è³‡æ–™å¤±æ•—: ' + e.message,'error');
        loadLocalData();
      } finally { showLoading(false); }
    }

    // =========================
    // UI è¼”åŠ©
    // =========================
    function updateSyncStatus(text, isOnline) {
      const statusElement = document.getElementById('syncStatus');
      const statusText = document.getElementById('statusText');
      statusText.textContent = text;
      statusElement.className = `sync-status ${isOnline ? 'online' : 'offline'}`;
      
      const signOutBtn = document.getElementById('signOutBtn');
      if (signOutBtn) {
        signOutBtn.style.display = isOnline ? 'inline-block' : 'none';
      }
    }
    
    function showLoading(show) {
      const spinner = document.getElementById('loadingSpinner');
      const syncBtn = document.getElementById('syncBtnText');
      if (show) { 
        spinner.style.display='inline-block'; 
        syncBtn.textContent='åŒæ­¥ä¸­...'; 
      } else { 
        spinner.style.display='none'; 
        syncBtn.textContent='ğŸ”„ åŒæ­¥è³‡æ–™'; 
      }
    }
    
    function showNotification(message, type) {
      const n = document.createElement('div');
      n.className = `notification ${type}`; 
      n.textContent = message;
      document.body.appendChild(n);
      setTimeout(()=> n.classList.add('show'), 60);
      setTimeout(()=>{
        n.classList.remove('show');
        setTimeout(()=> document.body.removeChild(n), 300);
      }, 3000);
    }

    function switchTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.content').forEach(c => c.classList.remove('active'));
      const btn = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
      if (btn) btn.classList.add('active');
      document.getElementById(tabName).classList.add('active');
      if (tabName === 'portfolio') updatePortfolio();
      if (tabName === 'analysis') updateAnalysis();
      if (tabName === 'exchange') updateExchangeTable();
      if (tabName === 'capital') updateCapitalTable();
      if (tabName === 'settings') { loadFeeSettings(); loadAppSettingsUI(); }
    }

    function setDefaultDates() {
      const today = new Date().toISOString().split('T')[0];
      ['date','exchangeDate','capitalDate','sellDate'].forEach(id=>{
        const el = document.getElementById(id); 
        if (el) el.value = today;
      });
    }

    // =========================
    // å¤šå¸³æˆ¶æ ¸å¿ƒ
    // =========================
    function createEmptyAccount(name='é è¨­å¸³æˆ¶', type='ç¾è‚¡', baseCurrency='TWD') {
      return {
        id: _genAccId(), name, type, baseCurrency,
        transactions: [], exchanges: [], capitalRecords: [], deposits: [],
        feeSettings: JSON.parse(JSON.stringify(feeSettings)),
        createdAt: new Date().toISOString()
      };
    }
    
    function hydrateFromAccount() {
      if (!currentAccountId || !accounts[currentAccountId]) return;
      const acc = accounts[currentAccountId];
      transactions   = acc.transactions || [];
      exchanges      = acc.exchanges || [];
      capitalRecords = acc.capitalRecords || [];
      deposits       = acc.deposits || [];
      feeSettings    = acc.feeSettings || feeSettings;
      updateTransactionTable(); updateExchangeTable(); updatePortfolio(); 
      updateCapitalTable(); updateDepositTable(); loadFeeSettings(); updateAnalysis(); updateAccountMeta();
    }
    
    function flushWorkingSetsToAccount() {
      if (!currentAccountId) return;
      if (!accounts[currentAccountId]) accounts[currentAccountId] = createEmptyAccount();
      accounts[currentAccountId].transactions   = transactions;
      accounts[currentAccountId].exchanges      = exchanges;
      accounts[currentAccountId].capitalRecords = capitalRecords;
      accounts[currentAccountId].deposits       = deposits;
      accounts[currentAccountId].feeSettings    = feeSettings;
    }
      exchanges      = acc.exchanges || [];
      capitalRecords = acc.capitalRecords || [];
      feeSettings    = acc.feeSettings || feeSettings;
      updateTransactionTable(); updateExchangeTable(); updatePortfolio(); 
      updateCapitalTable(); loadFeeSettings(); updateAnalysis(); updateAccountMeta();
    }
    
    function flushWorkingSetsToAccount() {
      if (!currentAccountId) return;
      if (!accounts[currentAccountId]) accounts[currentAccountId] = createEmptyAccount();
      accounts[currentAccountId].transactions   = transactions;
      accounts[currentAccountId].exchanges      = exchanges;
      accounts[currentAccountId].capitalRecords = capitalRecords;
      accounts[currentAccountId].feeSettings    = feeSettings;
    }
    
    function refreshAccountSelect() {
      const sel = document.getElementById('accountSelect'); 
      if (!sel) return;
      sel.innerHTML = '';
      Object.values(accounts).forEach(acc => {
        const opt = document.createElement('option');
        opt.value = acc.id; 
        opt.textContent = `${acc.name} (${acc.type})`;
        if (acc.id === currentAccountId) opt.selected = true;
        sel.appendChild(opt);
      });
    }
    
    function onAccountChange(id) { 
      flushWorkingSetsToAccount(); 
      currentAccountId = id; 
      saveLocalData(); 
      hydrateFromAccount(); 
      showNotification('å·²åˆ‡æ›å¸³æˆ¶','success'); 
    }
    
    function createAccount() {
      const name = prompt('æ–°å¸³æˆ¶åç¨±ï¼ˆä¾‹ï¼šç¾è‚¡é•·æŠ•ï¼æ•™è‚²åŸºé‡‘ï¼‰','æ–°å¸³æˆ¶'); 
      if (!name) return;
      const type = prompt('äº¤æ˜“é¡å‹ï¼ˆä¾‹ï¼šç¾è‚¡ï¼èè³‡ï¼è¤‡å§”è¨—ï¼ETFï¼å…¶ä»–ï¼‰','ç¾è‚¡') || 'ç¾è‚¡';
      const baseCurrency = prompt('åŸºç¤å¹£åˆ¥ï¼ˆTWDï¼USDï¼CNY ...ï¼‰','TWD') || 'TWD';
      const acc = createEmptyAccount(name, type, baseCurrency);
      accounts[acc.id] = acc; 
      currentAccountId = acc.id;
      refreshAccountSelect(); 
      hydrateFromAccount(); 
      saveLocalData();
      showNotification('å·²æ–°å¢å¸³æˆ¶','success');
    }
    
    function renameAccount() {
      if (!currentAccountId) return;
      const acc = accounts[currentAccountId];
      const name = prompt('é‡æ–°å‘½åå¸³æˆ¶', acc.name); 
      if (!name) return;
      acc.name = name; 
      refreshAccountSelect(); 
      updateAccountMeta(); 
      saveLocalData();
      showNotification('å¸³æˆ¶å·²é‡æ–°å‘½å','success');
    }
    
    function removeAccount() {
      if (!currentAccountId) return;
      if (Object.keys(accounts).length <= 1) return alert('è‡³å°‘éœ€ä¿ç•™ä¸€å€‹å¸³æˆ¶');
      if (!confirm('ç¢ºå®šåˆªé™¤æ­¤å¸³æˆ¶ï¼Ÿæ­¤å‹•ä½œç„¡æ³•å¾©åŸï¼')) return;
      delete accounts[currentAccountId];
      currentAccountId = Object.keys(accounts)[0];
      saveLocalData(); 
      refreshAccountSelect(); 
      hydrateFromAccount();
      showNotification('å¸³æˆ¶å·²åˆªé™¤','success');
    }
    
    function updateAccountMeta() {
      const el = document.getElementById('accountMeta'); 
      if (!el) return;
      const acc = accounts[currentAccountId]; 
      if (!acc) { el.textContent=''; return; }
      el.textContent = `å¸³æˆ¶IDï¼š${acc.id}ï½œé¡å‹ï¼š${acc.type}ï½œåŸºç¤å¹£åˆ¥ï¼š${acc.baseCurrency}`;
    }
    
    function initAccounts() {
      try {
        const saved = localStorage.getItem('accounts');
        const selected = localStorage.getItem('selectedAccountId');
        if (saved) { 
          accounts = JSON.parse(saved) || {}; 
          currentAccountId = selected || Object.keys(accounts)[0]; 
        } else {
          const def = createEmptyAccount('é è¨­å¸³æˆ¶','ç¾è‚¡','TWD');
          def.transactions = JSON.parse(localStorage.getItem('stockTransactions') || '[]');
          def.exchanges    = JSON.parse(localStorage.getItem('exchangeRecords')   || '[]');
          def.capitalRecords = JSON.parse(localStorage.getItem('capitalRecords') || '[]');
          const savedSettings = localStorage.getItem('feeSettings');
          def.feeSettings = savedSettings ? JSON.parse(savedSettings) : feeSettings;
          accounts[def.id] = def; 
          currentAccountId = def.id;
          localStorage.setItem('accounts', JSON.stringify(accounts));
          localStorage.setItem('selectedAccountId', currentAccountId);
        }
      } catch (e) {
        console.error('è®€å–å¸³æˆ¶å¤±æ•—ï¼Œå»ºç«‹é è¨­å¸³æˆ¶', e);
        const def = createEmptyAccount(); 
        accounts = { [def.id]: def }; 
        currentAccountId = def.id;
      }
      refreshAccountSelect(); 
      hydrateFromAccount();
    }

    // æœ¬åœ°è³‡æ–™
    function loadLocalData() { initAccounts(); }
    
    function saveLocalData() {
      try {
        flushWorkingSetsToAccount();
        localStorage.setItem('accounts', JSON.stringify(accounts));
        localStorage.setItem('selectedAccountId', currentAccountId);
        // èˆ‡èˆŠç‰ˆç›¸å®¹ï¼ˆä¿ç•™ï¼‰
        localStorage.setItem('stockTransactions', JSON.stringify(transactions));
        localStorage.setItem('exchangeRecords', JSON.stringify(exchanges));
        localStorage.setItem('capitalRecords', JSON.stringify(capitalRecords));
        localStorage.setItem('depositRecords', JSON.stringify(deposits));
        localStorage.setItem('feeSettings', JSON.stringify(feeSettings));
        localStorage.setItem('appSettings', JSON.stringify(appSettings));
      } catch (e){ console.error('å„²å­˜æœ¬åœ°è³‡æ–™å¤±æ•—:', e); }
    }

    // =========================
    // çµ±ä¸€å ±åƒ¹API
    // =========================
    async function fetchUnifiedQuote(symbol, market) {
      const apiKey = appSettings.alphaVantageKey;
      if (!apiKey) return null;
      
      try {
        let apiSymbol = symbol;
        if (market === 'TW') {
          // å°è‚¡éœ€è¦åŠ ä¸Šäº¤æ˜“æ‰€å¾Œç¶´
          apiSymbol = `${symbol}.TPE`;
        }
        
        const url = `https://www.alphavantage.co/query?function=GLOBAL_QUOTE&symbol=${encodeURIComponent(apiSymbol)}&apikey=${encodeURIComponent(apiKey)}`;
        const res = await fetch(url);
        
        if (!res.ok) return null;
        const data = await res.json();
        
        if (data['Error Message'] || data['Note']) {
          console.warn('Alpha Vantage APIé™åˆ¶æˆ–éŒ¯èª¤:', data);
          return null;
        }
        
        const quote = data['Global Quote'];
        if (!quote) return null;
        
        const price = parseFloat(quote['05. price']);
        const name = quote['01. symbol'];
        
        return {
          price: !isNaN(price) && price > 0 ? price : null,
          name: name || ''
        };
      } catch (e) {
        console.warn('çµ±ä¸€APIæŸ¥åƒ¹å¤±æ•—:', e);
        return null;
      }
    }

    async function fetchSeparateQuote(symbol, market) {
      try {
        if (market === 'TW') {
          return await fetchTWSEQuote(symbol);
        } else if (market === 'US') {
          const token = appSettings.finnhubKey;
          if (!token) return null;
          const url = `https://finnhub.io/api/v1/quote?symbol=${encodeURIComponent(symbol)}&token=${encodeURIComponent(token)}`;
          const res = await fetch(url);
          if (!res.ok) return null;
          const data = await res.json();
          const price = (typeof data.c==='number' && data.c>0) ? data.c : null;
          return price ? { price, name: '' } : null;
        }
      } catch (e) {
        console.warn('åˆ†é›¢APIæŸ¥åƒ¹å¤±æ•—:', e);
        return null;
      }
      return null;
    }

    async function fetchTWSEQuote(symbol) {
      const clean = symbol.replace(/\s+/g,'').toUpperCase();
      const url = `https://mis.twse.com.tw/stock/api/getStockInfo.jsp?json=1&delay=0&ex_ch=tse_${encodeURIComponent(clean)}.tw`;
      try {
        const res = await fetch(url);
        if (!res.ok) return null;
        const data = await res.json();
        const arr = (data && data.msgArray) || [];
        if (!arr.length) return null;
        const it = arr[0] || {};
        const z = parseFloat(it.z); // æˆäº¤åƒ¹
        const y = parseFloat(it.y); // æ˜¨æ”¶
        const price = !isNaN(z) && z>0 ? z : (!isNaN(y) ? y : NaN);
        if (isNaN(price)) return null;
        return { price, name: it.n || '' };
      } catch (e) {
        console.warn('TWSE fetch error:', e);
        return null;
      }
    }

    function getCurrentPrice(symbol, market) {
      const key = `${market}-${symbol}`;
      const useLive = (String(appSettings.useLivePrice)==='true') || appSettings.useLivePrice===true;
      const entry = currentPrices[key];
      const expired = !entry || !entry._ts || (Date.now() - entry._ts > 60*1000);
      
      if (useLive && expired) {
        fetchLivePrice(symbol, market).then(quote=>{
          if (quote && typeof quote.price==='number' && quote.price>0) {
            currentPrices[key] = { value: quote.price, name: quote.name || '', _ts: Date.now() };
            updatePortfolio(); 
            updateAnalysis();
          }
        }).catch(()=>{});
      }
      
      if (entry && typeof entry.value === 'number') return entry.value;

      // æ²’æœ‰å³æ™‚åƒ¹ï¼šç”¨æœ€è¿‘ä¸€ç­†æˆäº¤åƒ¹å¾®å¹…æ“¾å‹•
      const last = transactions.filter(t=> t.symbol===symbol && t.market===market)
                               .sort((a,b)=> new Date(b.date)-new Date(a.date))[0];
      let value = 100;
      if (last) {
        const fluctuation = (Math.random()-0.5) * 0.1;
        value = last.price * (1 + fluctuation);
      }
      currentPrices[key] = { value, _ts: Date.now() };
      return value;
    }

    async function fetchLivePrice(symbol, market) {
      const provider = appSettings.priceApiProvider || 'unified';
      
      if (provider === 'unified') {
        return await fetchUnifiedQuote(symbol, market);
      } else {
        return await fetchSeparateQuote(symbol, market);
      }
    }

    // äº¤æ˜“è¡¨å–®ä¸Šçš„æŸ¥åƒ¹/å¡«åƒ¹åŠŸèƒ½
    async function peekQuote() {
      const market = document.getElementById('market').value;
      const symbol = document.getElementById('symbol').value.trim().toUpperCase();
      const hint = document.getElementById('lastQuoteHint');
      
      if (!market || !symbol) { 
        hint.textContent=''; 
        return; 
      }
      
      hint.textContent = 'æŸ¥è©¢ä¸­â€¦';
      
      const quote = await fetchLivePrice(symbol, market);
      
      if (quote && typeof quote.price === 'number') {
        lastPeekPrice = quote.price;
        hint.textContent = `å³æ™‚åƒ¹ï¼š${quote.price.toFixed(2)}${quote.name ? 'ï½œåç¨±ï¼š'+quote.name : ''}`;
        
        // è‹¥åç¨±æ¬„ä½ç‚ºç©ºä¸”æœ‰å›å‚³åç¨±ï¼Œè‡ªå‹•å¡«å…¥
        if (quote.name && !document.getElementById('name').value.trim()) {
          document.getElementById('name').value = quote.name;
        }
      } else {
        hint.textContent = 'æŸ¥åƒ¹å¤±æ•—ï¼ˆå¯èƒ½ç‚ºAPIé™åˆ¶æˆ–ä»£è™Ÿæœ‰èª¤ï¼‰';
      }
    }
    
    async function fillCurrentPrice() {
      if (lastPeekPrice) {
        document.getElementById('price').value = lastPeekPrice.toFixed(2);
        calculateFees();
      } else {
        await peekQuote();
        if (lastPeekPrice) {
          document.getElementById('price').value = lastPeekPrice.toFixed(2);
          calculateFees();
        }
      }
    }

    // APIé€£ç·šæ¸¬è©¦
    async function testApiConnection() {
      const provider = appSettings.priceApiProvider || 'unified';
      const statusEl = document.getElementById('priceApiStatus');
      
      statusEl.textContent = 'APIç‹€æ…‹ï¼šæ¸¬è©¦ä¸­...';
      statusEl.className = 'api-status warning';
      
      try {
        let testResult = null;
        
        if (provider === 'unified') {
          const apiKey = appSettings.alphaVantageKey;
          if (!apiKey) {
            statusEl.textContent = 'APIç‹€æ…‹ï¼šè«‹å…ˆè¨­å®šAlpha Vantage API Key';
            statusEl.className = 'api-status error';
            return;
          }
          
          // æ¸¬è©¦ç¾è‚¡
          testResult = await fetchUnifiedQuote('AAPL', 'US');
        } else {
          // æ¸¬è©¦åˆ†é›¢æ¨¡å¼
          const twResult = await fetchSeparateQuote('2330', 'TW');
          const usResult = await fetchSeparateQuote('AAPL', 'US');
          testResult = twResult || usResult;
        }
        
        if (testResult && testResult.price) {
          statusEl.textContent = `APIç‹€æ…‹ï¼šé€£ç·šæ­£å¸¸ (æ¸¬è©¦åƒ¹æ ¼: ${testResult.price})`;
          statusEl.className = 'api-status success';
        } else {
          statusEl.textContent = 'APIç‹€æ…‹ï¼šç„¡æ³•å–å¾—å ±åƒ¹è³‡æ–™';
          statusEl.className = 'api-status error';
        }
      } catch (e) {
        statusEl.textContent = `APIç‹€æ…‹ï¼šé€£ç·šå¤±æ•— (${e.message})`;
        statusEl.className = 'api-status error';
      }
    }

    // =========================
    // è³‡æœ¬ç®¡ç†
    // =========================
    document.getElementById('capitalForm').addEventListener('submit', function(e){
      e.preventDefault();
      const capital = {
        id: Date.now(),
        date: document.getElementById('capitalDate').value,
        type: document.getElementById('capitalType').value,
        amount: parseFloat(document.getElementById('capitalAmount').value),
        note: document.getElementById('capitalNote').value
      };
      capitalRecords.push(capital);
      saveLocalData(); 
      updateCapitalTable(); 
      updateCapitalStats(); 
      updateAnalysis();
      this.reset(); 
      setDefaultDates();
      showNotification('è³‡æœ¬ç´€éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
    });

    function updateCapitalTable() {
      const tbody = document.getElementById('capitalTable'); 
      tbody.innerHTML='';
      const sortedRecords = [...capitalRecords].sort((a,b)=> new Date(b.date)-new Date(a.date));
      let cumulativeCapital = 0;
      const ordered = [...capitalRecords].sort((a,b)=> new Date(a.date)-new Date(b.date));
      const cumulativeAmounts = {};
      ordered.forEach(r=>{
        if (r.type === 'è³‡é‡‘æå–') cumulativeCapital -= r.amount; 
        else cumulativeCapital += r.amount;
        cumulativeAmounts[r.id]=cumulativeCapital;
      });
      sortedRecords.forEach(r=>{
        const tr = tbody.insertRow();
        const typeColor = r.type==='è³‡é‡‘æå–' ? '#dc3545' : '#28a745';
        const amountDisplay = r.type==='è³‡é‡‘æå–' ? `-${r.amount.toFixed(2)}` : `+${r.amount.toFixed(2)}`;
        tr.innerHTML = `
          <td>${r.date}</td>
          <td style="color:${typeColor};font-weight:600;">${r.type}</td>
          <td style="color:${typeColor};font-weight:600;">${amountDisplay}</td>
          <td>${(cumulativeAmounts[r.id]||0).toFixed(2)}</td>
          <td>${r.note || '-'}</td>
          <td><button class="delete-btn" onclick="deleteCapitalRecord(${r.id})">åˆªé™¤</button></td>`;
      });
      updateCapitalStats();
    }
    
    function updateCapitalStats() {
      let totalCapital=0, totalInvested=0;
      capitalRecords.forEach(r=>{ 
        totalCapital += (r.type==='è³‡é‡‘æå–' ? -r.amount : r.amount); 
      });
      transactions.forEach(t=>{
        if (t.type==='è²·é€²') totalInvested += t.totalAmount;
        else totalInvested -= t.totalAmount;
      });
      const availableCapital = totalCapital - totalInvested;
      document.getElementById('totalCapital').textContent = `${totalCapital.toFixed(2)}`;
      document.getElementById('availableCapital').textContent = `${availableCapital.toFixed(2)}`;
      document.getElementById('investedCapital').textContent = `${totalInvested.toFixed(2)}`;
      document.getElementById('availableCapital').className = availableCapital>=0 ? 'stat-value' : 'stat-value loss';
    }
    
    function deleteCapitalRecord(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤è³‡æœ¬ç´€éŒ„å—ï¼Ÿ')) return;
      capitalRecords = capitalRecords.filter(r=> r.id!==id);
      saveLocalData(); 
      updateCapitalTable(); 
      updateCapitalStats(); 
      updateAnalysis();
      showNotification('è³‡æœ¬ç´€éŒ„å·²åˆªé™¤','success');
    }

    // =========================
    // å¿«é€Ÿè³£å‡º
    // =========================
    function openSellModal(market, symbol, name, availableQuantity) {
      currentSellStock = { market, symbol, name, availableQuantity };
      document.getElementById('sellStockInfo').value = `${market}-${symbol} (${name})`;
      document.getElementById('sellAvailableQuantity').value = availableQuantity;
      document.getElementById('sellQuantity').value = '';
      document.getElementById('sellQuantity').max = availableQuantity;
      document.getElementById('sellPrice').value = '';
      document.getElementById('sellNote').value = '';
      setDefaultDates();
      document.getElementById('sellModal').style.display='block';
    }
    
    function closeSellModal(){ 
      document.getElementById('sellModal').style.display='none'; 
      currentSellStock=null; 
      document.getElementById('sellForm').reset(); 
    }
    
    document.getElementById('sellForm').addEventListener('submit', function(e){
      e.preventDefault();
      if (!currentSellStock) return;
      
      const sellQuantity = parseFloat(document.getElementById('sellQuantity').value);
      const sellPrice = parseFloat(document.getElementById('sellPrice').value);
      const sellDate = document.getElementById('sellDate').value;
      const sellNote = document.getElementById('sellNote').value;
      
      if (sellQuantity > currentSellStock.availableQuantity) { 
        showNotification('è³£å‡ºæ•¸é‡ä¸èƒ½è¶…éæŒæœ‰æ•¸é‡','error'); 
        return; 
      }

      const sellTransaction = {
        id: Date.now(), 
        date: sellDate, 
        market: currentSellStock.market, 
        symbol: currentSellStock.symbol,
        name: currentSellStock.name, 
        type:'è³£å‡º', 
        quantity:sellQuantity, 
        price:sellPrice, 
        isOddLot:false, 
        fee:0, 
        tax:0, 
        note:sellNote
      };
      
      const totalAmount = sellQuantity * sellPrice;
      if (currentSellStock.market === 'TW') {
        const feeRate = feeSettings.tw.feeRate / 100;
        sellTransaction.fee = Math.max(totalAmount*feeRate, feeSettings.tw.minFee);
        sellTransaction.tax = totalAmount * (feeSettings.tw.taxRate / 100);
      } else if (currentSellStock.market === 'US') {
        if (feeSettings.us.feeType === 'fixed') sellTransaction.fee = feeSettings.us.fixedFee;
        else sellTransaction.fee = Math.max(totalAmount * (feeSettings.us.feeRate / 100), feeSettings.us.minFee);
      }
      sellTransaction.totalAmount = totalAmount - sellTransaction.fee - sellTransaction.tax;

      transactions.push(sellTransaction);
      saveLocalData();
      updateTransactionTable(); 
      updatePortfolio(); 
      updateAnalysis();
      closeSellModal();
      showNotification(`æˆåŠŸè³£å‡º ${sellQuantity} è‚¡ ${currentSellStock.symbol}ï¼`,'success');
    });
    
    window.onclick = function(ev){ 
      const m = document.getElementById('sellModal'); 
      if (ev.target === m) closeSellModal(); 
    };

    // =========================
    // äº¤æ˜“è¡¨å–®
    // =========================
    document.getElementById('transactionForm').addEventListener('submit', function(e){
      e.preventDefault();
      const transaction = {
        id: Date.now(),
        date: document.getElementById('date').value,
        market: document.getElementById('market').value,
        symbol: document.getElementById('symbol').value.toUpperCase().trim(),
        name: document.getElementById('name').value.trim(),
        type: document.getElementById('type').value,
        quantity: parseFloat(document.getElementById('quantity').value),
        price: parseFloat(document.getElementById('price').value),
        isOddLot: document.getElementById('oddLot').value === 'true',
        fee: parseFloat(document.getElementById('fee').value) || 0,
        tax: parseFloat(document.getElementById('tax').value) || 0,
        note: document.getElementById('note').value
      };
      
      if (transaction.type === 'è²·é€²') {
        transaction.totalAmount = (transaction.quantity * transaction.price) + transaction.fee + transaction.tax;
      } else {
        transaction.totalAmount = (transaction.quantity * transaction.price) - transaction.fee - transaction.tax;
      }

      transactions.push(transaction);
      saveLocalData();
      updateTransactionTable(); 
      updatePortfolio(); 
      updateAnalysis();
      this.reset(); 
      setDefaultDates(); 
      document.getElementById('oddLot').value='false';
      document.getElementById('lastQuoteHint').textContent = '';
      showNotification('äº¤æ˜“ç´€éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
    });

    // =========================
    // æ›åŒ¯è¡¨å–®
    // =========================
    document.getElementById('exchangeForm').addEventListener('submit', function(e){
      e.preventDefault();
      const exchange = {
        id: Date.now(),
        date: document.getElementById('exchangeDate').value,
        type: document.getElementById('exchangeType').value,
        fromAmount: parseFloat(document.getElementById('fromAmount').value),
        rate: parseFloat(document.getElementById('exchangeRate').value),
        toAmount: parseFloat(document.getElementById('toAmount').value),
        fee: parseFloat(document.getElementById('exchangeFee').value) || 0,
        bank: document.getElementById('exchangeBank').value,
        note: document.getElementById('exchangeNote').value
      };
      exchanges.push(exchange);
      saveLocalData(); 
      updateExchangeTable(); 
      updateAnalysis();
      this.reset(); 
      setDefaultDates();
      showNotification('æ›åŒ¯ç´€éŒ„å·²æ–°å¢æˆåŠŸï¼','success');
    });
    
    function calculateExchangeAmount() {
      const fromAmount = parseFloat(document.getElementById('fromAmount').value) || 0;
      const rate = parseFloat(document.getElementById('exchangeRate').value) || 0;
      if (fromAmount && rate) document.getElementById('toAmount').value = (fromAmount*rate).toFixed(4);
    }

    // =========================
    // è¡¨æ ¼ï¼ˆäº¤æ˜“/æ›åŒ¯ï¼‰
    // =========================
    function updateTransactionTable() {
      const tbody = document.getElementById('transactionTable'); 
      tbody.innerHTML='';
      const sorted = [...transactions].sort((a,b)=> new Date(b.date)-new Date(a.date));
      sorted.forEach(t=>{
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td>${t.date}</td>
          <td><span class="market-indicator market-${t.market.toLowerCase()}">${t.market}</span></td>
          <td>${t.symbol}</td>
          <td>${t.name}</td>
          <td><span style="color:${t.type==='è²·é€²'?'#28a745':'#dc3545'}">${t.type}</span></td>
          <td>${t.quantity.toLocaleString()}</td>
          <td>${t.price.toFixed(2)}</td>
          <td>${t.isOddLot ? 'âœ“':'âœ—'}</td>
          <td>${t.fee.toFixed(2)}</td>
          <td>${t.tax.toFixed(2)}</td>
          <td>${t.totalAmount.toFixed(2)}</td>
          <td>${t.note || '-'}</td>
          <td><button class="delete-btn" onclick="deleteTransaction(${t.id})">åˆªé™¤</button></td>`;
      });
    }
    
    function updateExchangeTable() {
      const tbody = document.getElementById('exchangeTable'); 
      tbody.innerHTML='';
      const sorted = [...exchanges].sort((a,b)=> new Date(b.date)-new Date(a.date));
      sorted.forEach(e=>{
        const [fromCurrency,toCurrency] = e.type.split('-');
        const tr = tbody.insertRow();
        tr.innerHTML = `
          <td>${e.date}</td>
          <td>${fromCurrency} â†’ ${toCurrency}</td>
          <td>${e.fromAmount.toLocaleString()} ${fromCurrency}</td>
          <td>${e.rate.toFixed(4)}</td>
          <td>${e.toAmount.toLocaleString()} ${toCurrency}</td>
          <td>${e.fee.toFixed(2)}</td>
          <td>${e.bank || '-'}</td>
          <td>${e.note || '-'}</td>
          <td><button class="delete-btn" onclick="deleteExchange(${e.id})">åˆªé™¤</button></td>`;
      });
    }
    
    function deleteTransaction(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤äº¤æ˜“ç´€éŒ„å—ï¼Ÿ')) return;
      transactions = transactions.filter(t=> t.id!==id);
      saveLocalData(); 
      updateTransactionTable(); 
      updatePortfolio(); 
      updateAnalysis();
      showNotification('äº¤æ˜“ç´€éŒ„å·²åˆªé™¤','success');
    }
    
    function deleteExchange(id) {
      if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤æ›åŒ¯ç´€éŒ„å—ï¼Ÿ')) return;
      exchanges = exchanges.filter(e=> e.id!==id);
      saveLocalData(); 
      updateExchangeTable(); 
      updateAnalysis();
      showNotification('æ›åŒ¯ç´€éŒ„å·²åˆªé™¤','success');
    }

    // =========================
    // è²»ç”¨è¨ˆç®—
    // =========================
    function calculateFees() {
      const market = document.getElementById('market').value;
      const quantity = parseFloat(document.getElementById('quantity').value) || 0;
      const price = parseFloat(document.getElementById('price').value) || 0;
      const type = document.getElementById('type').value;
      const isOddLot = document.getElementById('oddLot').value === 'true';
      
      if (!market || !quantity || !price) { 
        document.getElementById('fee').value=''; 
        document.getElementById('tax').value=''; 
        return; 
      }
      
      const totalAmount = quantity * price; 
      let fee=0, tax=0;
      
      if (market==='TW') {
        const feeRate = feeSettings.tw.feeRate / 100;
        fee = Math.max(totalAmount*feeRate, isOddLot ? feeSettings.tw.oddLotMinFee : feeSettings.tw.minFee);
        if (type==='è³£å‡º') tax = totalAmount * (feeSettings.tw.taxRate / 100);
      } else if (market==='US') {
        if (feeSettings.us.feeType==='fixed') fee = feeSettings.us.fixedFee;
        else fee = Math.max(totalAmount * (feeSettings.us.feeRate / 100), feeSettings.us.minFee);
      }
      
      document.getElementById('fee').value = fee.toFixed(2);
      document.getElementById('tax').value = tax.toFixed(2);
    }

    // =========================
    // æŒå€‰æ˜ç´°
    // =========================
    function updatePortfolio() {
      const portfolio = {};
      transactions.forEach(t=>{
        const key = `${t.market}-${t.symbol}`;
        if (!portfolio[key]) {
          portfolio[key] = { 
            market:t.market, 
            symbol:t.symbol, 
            name:t.name, 
            totalQuantity:0, 
            totalCost:0, 
            transactions:[] 
          };
        }
        portfolio[key].transactions.push(t);
        if (t.type==='è²·é€²'){ 
          portfolio[key].totalQuantity += t.quantity; 
          portfolio[key].totalCost += t.totalAmount; 
        } else {
          portfolio[key].totalQuantity -= t.quantity;
          if (portfolio[key].totalQuantity + t.quantity > 0) {
            const avgCost = portfolio[key].totalCost / (portfolio[key].totalQuantity + t.quantity);
            portfolio[key].totalCost -= t.quantity * avgCost;
          }
        }
      });
      
      const tbody = document.getElementById('portfolioTable'); 
      tbody.innerHTML='';
      Object.values(portfolio).forEach(h=>{
        if (h.totalQuantity > 0) {
          const avgCost = h.totalCost / h.totalQuantity;
          const currentPrice = getCurrentPrice(h.symbol, h.market);
          const marketValue = h.totalQuantity * currentPrice;
          const unrealizedPL = marketValue - h.totalCost;
          const returnRate = (unrealizedPL / h.totalCost) * 100;
          const tr = tbody.insertRow();
          tr.innerHTML = `
            <td><span class="market-indicator market-${h.market.toLowerCase()}">${h.market}</span></td>
            <td>${h.symbol}</td>
            <td>${h.name}</td>
            <td>${h.totalQuantity.toLocaleString()}</td>
            <td>${avgCost.toFixed(2)}</td>
            <td>${h.totalCost.toFixed(2)}</td>
            <td>${currentPrice.toFixed(2)}</td>
            <td>${marketValue.toFixed(2)}</td>
            <td class="${unrealizedPL>=0?'profit':'loss'}">${unrealizedPL.toFixed(2)}</td>
            <td class="${returnRate>=0?'profit':'loss'}">${returnRate.toFixed(2)}%</td>
            <td><button class="btn-sell" onclick="openSellModal('${h.market}','${h.symbol}','${h.name}',${h.totalQuantity})">å¿«é€Ÿè³£å‡º</button></td>`;
        }
      });
    }

    // =========================
    // ç¸¾æ•ˆåˆ†æ + å·²å¯¦ç¾/æ›åŒ¯æç›Š
    // =========================
    function updateAnalysis() {
      let totalInvestment=0, totalValue=0, totalExchangeFee=0;
      const portfolio = {};
      
      transactions.forEach(t=>{
        const key = `${t.market}-${t.symbol}`;
        if (!portfolio[key]) portfolio[key] = { totalQuantity:0, totalCost:0, name:t.name };
        if (t.type==='è²·é€²'){ 
          portfolio[key].totalQuantity += t.quantity; 
          portfolio[key].totalCost += t.totalAmount; 
        } else {
          portfolio[key].totalQuantity -= t.quantity;
          if (portfolio[key].totalQuantity + t.quantity > 0) {
            const avgCost = portfolio[key].totalCost / (portfolio[key].totalQuantity + t.quantity);
            portfolio[key].totalCost -= t.quantity * avgCost;
          }
        }
      });
      
      Object.entries(portfolio).forEach(([key,h])=>{
        if (h.totalQuantity>0) {
          totalInvestment += h.totalCost;
          const [market,symbol] = key.split('-');
          const currentPrice = getCurrentPrice(symbol, market);
          totalValue += h.totalQuantity * currentPrice;
        }
      });
      
      exchanges.forEach(e=> totalExchangeFee += e.fee );
      const totalProfit = totalValue - totalInvestment;
      const totalReturn = totalInvestment>0 ? (totalProfit/totalInvestment)*100 : 0;
      
      document.getElementById('totalInvestment').textContent = `${totalInvestment.toFixed(2)}`;
      document.getElementById('totalValue').textContent = `${totalValue.toFixed(2)}`;
      
      const tpEl = document.getElementById('totalProfit'); 
      tpEl.textContent = `${totalProfit.toFixed(2)}`; 
      tpEl.className = totalProfit>=0 ? 'stat-value profit':'stat-value loss';
      
      const trEl = document.getElementById('totalReturn'); 
      trEl.textContent = `${totalReturn.toFixed(2)}%`; 
      trEl.className = totalReturn>=0 ? 'stat-value profit':'stat-value loss';
      
      document.getElementById('totalExchangeFee').textContent = `${totalExchangeFee.toFixed(2)}`;

      // å€‹è‚¡å·²å¯¦ç¾æç›Š
      const _r = computeRealizedPnLEvents();
      const rp = document.getElementById('realizedProfitTotal');
      if (rp) { 
        rp.textContent = `${_r.total.toFixed(2)}`; 
        rp.className = _r.total>=0 ? 'stat-value profit' : 'stat-value loss'; 
      }
      renderRealizedTable(_r.events);

      // æ›åŒ¯æç›Š
      const _fx = computeFxPnL();
      const fxp = document.getElementById('fxProfitTotal');
      if (fxp) { 
        fxp.textContent = `${_fx.total.toFixed(2)}`; 
        fxp.className = _fx.total>=0 ? 'stat-value profit' : 'stat-value loss'; 
      }
      renderFxPnLTable(_fx.events);
    }

    function computeRealizedPnLEvents() {
      const sorted = [...transactions].sort((a,b)=> new Date(a.date)-new Date(b.date) || a.id-b.id);
      const state = {}; 
      const events = []; 
      let total=0;
      
      sorted.forEach(tx=>{
        const key = `${tx.market}-${tx.symbol}`;
        if (!state[key]) state[key] = { qty:0, cost:0, name:tx.name };
        
        if (tx.type==='è²·é€²') { 
          state[key].qty += tx.quantity; 
          state[key].cost += tx.totalAmount; 
        } else if (tx.type==='è³£å‡º') {
          const lotQty = Math.max(0, state[key].qty);
          const avgCost = lotQty>0 ? state[key].cost/lotQty : 0;
          const costPart = avgCost * tx.quantity;
          const proceeds = (tx.quantity*tx.price) - (tx.fee||0) - (tx.tax||0);
          const realized = proceeds - costPart;
          
          state[key].qty  -= tx.quantity;
          state[key].cost -= costPart;
          
          events.push({
            id:tx.id, date:tx.date, market:tx.market, symbol:tx.symbol, name:tx.name,
            quantity:tx.quantity, avgCost:avgCost, proceeds:proceeds, cost:costPart,
            realized:realized, returnPct: costPart>0 ? (realized/costPart)*100 : 0, note:tx.note || ''
          });
          total += realized;
        }
      });
      return { events, total };
    }
    
    function renderRealizedTable(list) {
      const tbody = document.getElementById('realizedTable'); 
      if (!tbody) return;
      tbody.innerHTML='';
      const rows = [...list].sort((a,b)=> new Date(b.date)-new Date(a.date));
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td><span class="market-indicator market-${r.market.toLowerCase()}">${r.market}</span></td>
          <td>${r.symbol}</td>
          <td>${r.name}</td>
          <td>${r.quantity.toLocaleString()}</td>
          <td>${r.avgCost.toFixed(2)}</td>
          <td>${r.proceeds.toFixed(2)}</td>
          <td>${r.cost.toFixed(2)}</td>
          <td class="${r.realized>=0?'profit':'loss'}">${r.realized.toFixed(2)}</td>
          <td class="${r.returnPct>=0?'profit':'loss'}">${r.returnPct.toFixed(2)}%</td>
          <td>${r.note || '-'}</td>`;
        tbody.appendChild(tr);
      });
    }

    function computeFxPnL() {
      const sorted = [...exchanges].sort((a,b)=> new Date(a.date)-new Date(b.date) || a.id-b.id);
      const pos = {}; 
      const events = []; 
      let total=0;
      const ensure = c => { if(!pos[c]) pos[c] = { qty:0, twdCost:0 }; };
      
      sorted.forEach(ex=>{
        const [from,to] = (ex.type||'').split('-');
        const fromAmt = Number(ex.fromAmount) || 0;
        const toAmt   = Number(ex.toAmount)   || (fromAmt * (Number(ex.rate)||0));
        const rate    = Number(ex.rate)       || (fromAmt ? toAmt/fromAmt : 0);
        const fee     = Number(ex.fee)        || 0;
        let feeTwd = 0;
        
        if (from==='TWD') feeTwd = fee; 
        else if (to==='TWD') feeTwd = fee * rate; 
        else feeTwd = 0;
        
        ensure(from); ensure(to);

        if (from==='TWD') {
          pos[to].qty     += toAmt;
          pos[to].twdCost += (fromAmt + feeTwd);
          events.push({ 
            id:ex.id, date:ex.date, pair:ex.type, action:'è²·å…¥å¤–å¹£', 
            qty:toAmt, rate, feeTwd, realized:0, note:ex.note||'' 
          });
        } else if (to==='TWD') {
          const available = pos[from].qty;
          const avgCost   = available>0 ? (pos[from].twdCost/available) : 0;
          const costTwd   = avgCost * fromAmt;
          const proceeds  = toAmt - feeTwd;
          const realized  = proceeds - costTwd;
          
          pos[from].qty     -= fromAmt;
          pos[from].twdCost -= costTwd;
          
          events.push({ 
            id:ex.id, date:ex.date, pair:ex.type, action:'è³£å‡ºå¤–å¹£',
            qty:fromAmt, rate, feeTwd, realized, note:ex.note||'' 
          });
          total += realized;
        } else {
          const available = pos[from].qty;
          const avgCost   = available>0 ? (pos[from].twdCost/available) : 0;
          const costFrom  = avgCost * fromAmt;
          
          pos[from].qty     -= fromAmt;
          pos[from].twdCost -= costFrom;
          pos[to].qty       += toAmt;
          pos[to].twdCost   += costFrom;
          
          events.push({ 
            id:ex.id, date:ex.date, pair:ex.type, action:'å¹£åˆ¥è½‰æ›', 
            qty:toAmt, rate, feeTwd:0, realized:0, note:ex.note||'' 
          });
        }
      });
      return { events, total };
    }
    
    function renderFxPnLTable(list) {
      const tbody = document.getElementById('fxPnLTable'); 
      if (!tbody) return;
      tbody.innerHTML = '';
      const rows = [...list].sort((a,b)=> new Date(b.date)-new Date(a.date));
      rows.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${r.date}</td>
          <td>${r.pair}</td>
          <td>${r.action}</td>
          <td>${r.qty.toLocaleString()}</td>
          <td>${(r.rate||0).toFixed(4)}</td>
          <td>${(r.feeTwd||0).toFixed(2)}</td>
          <td class="${(r.realized||0)>=0?'profit':'loss'}">${(r.realized||0).toFixed(2)}</td>
          <td>${r.note || '-'}</td>`;
        tbody.appendChild(tr);
      });
    }

    // =========================
    // è¨­å®šåŠŸèƒ½
    // =========================
    function loadFeeSettings() {
      document.getElementById('twFeeRate').value = feeSettings.tw.feeRate;
      document.getElementById('twMinFee').value = feeSettings.tw.minFee;
      document.getElementById('twOddLotMinFee').value = feeSettings.tw.oddLotMinFee;
      document.getElementById('twTaxRate').value = feeSettings.tw.taxRate;
      document.getElementById('usFeeType').value = feeSettings.us.feeType;
      document.getElementById('usFixedFee').value = feeSettings.us.fixedFee;
      document.getElementById('usFeeRate').value = feeSettings.us.feeRate;
      document.getElementById('usMinFee').value = feeSettings.us.minFee;
    }
    
    function saveFeeSettings() {
      feeSettings.tw.feeRate = parseFloat(document.getElementById('twFeeRate').value);
      feeSettings.tw.minFee = parseFloat(document.getElementById('twMinFee').value);
      feeSettings.tw.oddLotMinFee = parseFloat(document.getElementById('twOddLotMinFee').value);
      feeSettings.tw.taxRate = parseFloat(document.getElementById('twTaxRate').value);
      feeSettings.us.feeType = document.getElementById('usFeeType').value;
      feeSettings.us.fixedFee = parseFloat(document.getElementById('usFixedFee').value);
      feeSettings.us.feeRate = parseFloat(document.getElementById('usFeeRate').value);
      feeSettings.us.minFee = parseFloat(document.getElementById('usMinFee').value);
      saveLocalData(); 
      showNotification('è²»ç‡è¨­å®šå·²å„²å­˜ï¼','success');
    }
    
    function resetFeeSettings() {
      if (!confirm('ç¢ºå®šè¦é‡ç½®ç‚ºé è¨­è²»ç‡è¨­å®šå—ï¼Ÿ')) return;
      feeSettings = {
        tw: { feeRate: 0.1425, minFee: 20, oddLotMinFee: 1, taxRate: 0.3 },
        us: { feeType: 'fixed', fixedFee: 0, feeRate: 0, minFee: 0 }
      };
      saveLocalData(); 
      loadFeeSettings(); 
      showNotification('å·²é‡ç½®ç‚ºé è¨­è¨­å®šï¼','success');
    }
    
    function loadAppSettingsUI() {
      const useLive = document.getElementById('useLivePrice');
      const provider = document.getElementById('priceApiProvider');
      const alphaKey = document.getElementById('alphaVantageKey');
      const finnhubKey = document.getElementById('finnhubKey');
      
      if (useLive) useLive.value = String(appSettings.useLivePrice ? 'true':'false');
      if (provider) provider.value = appSettings.priceApiProvider || 'unified';
      if (alphaKey) alphaKey.value = appSettings.alphaVantageKey || '';
      if (finnhubKey) finnhubKey.value = appSettings.finnhubKey || '';
      
      // è¼‰å…¥ Firebase è¨­å®š
      const firebaseConfigEl = document.getElementById('firebaseConfig');
      if (firebaseConfigEl && firebaseConfig) {
        firebaseConfigEl.value = JSON.stringify(firebaseConfig, null, 2);
      }
    }
    
    function saveAppSettings() {
      const useLive = document.getElementById('useLivePrice');
      const provider = document.getElementById('priceApiProvider');
      const alphaKey = document.getElementById('alphaVantageKey');
      const finnhubKey = document.getElementById('finnhubKey');
      
      appSettings.useLivePrice = (useLive && useLive.value === 'true');
      appSettings.priceApiProvider = (provider && provider.value) || 'unified';
      appSettings.alphaVantageKey = (alphaKey && alphaKey.value ? alphaKey.value.trim() : '');
      appSettings.finnhubKey = (finnhubKey && finnhubKey.value ? finnhubKey.value.trim() : '');
      
      localStorage.setItem('appSettings', JSON.stringify(appSettings));
      currentPrices = {}; // æ¸…å¿«å–
      updatePortfolio(); 
      updateAnalysis();
      showNotification('å ±åƒ¹è¨­å®šå·²å„²å­˜','success');
    }

    function saveFirebaseConfig() {
      const configEl = document.getElementById('firebaseConfig');
      if (!configEl) return;
      
      try {
        const configText = configEl.value.trim();
        if (!configText) {
          firebaseConfig = null;
          localStorage.removeItem('firebaseConfig');
          showNotification('Firebaseè¨­å®šå·²æ¸…é™¤','success');
          updateFirebaseStatus('Firebase: æœªé…ç½® (åƒ…æœ¬åœ°æ¨¡å¼)', 'warning');
          return;
        }
        
        const config = JSON.parse(configText);
        
        // é©—è­‰å¿…è¦æ¬„ä½
        if (!config.apiKey || !config.authDomain || !config.databaseURL || !config.projectId) {
          throw new Error('è¨­å®šæª”æ¡ˆç¼ºå°‘å¿…è¦æ¬„ä½');
        }
        
        firebaseConfig = config;
        localStorage.setItem('firebaseConfig', JSON.stringify(config));
        showNotification('Firebaseè¨­å®šå·²å„²å­˜ï¼Œè«‹é‡æ–°åˆå§‹åŒ–','success');
        
      } catch (e) {
        showNotification('Firebaseè¨­å®šæ ¼å¼éŒ¯èª¤: ' + e.message, 'error');
      }
    }

    function initializeFirebase() {
      try {
        // é‡æ–°è¼‰å…¥è¨­å®š
        const savedConfig = localStorage.getItem('firebaseConfig');
        if (savedConfig) {
          firebaseConfig = JSON.parse(savedConfig);
        }
        
        FB.init();
        showNotification('Firebaseå·²é‡æ–°åˆå§‹åŒ–','success');
        
        // æ›´æ–°åŒæ­¥æŒ‰éˆ•ç‹€æ…‹
        const syncBtn = document.getElementById('syncBtn');
        if (syncBtn) {
          syncBtn.disabled = !FB.ready;
        }
        
      } catch (e) {
        showNotification('Firebaseåˆå§‹åŒ–å¤±æ•—: ' + e.message, 'error');
      }
    }

    // =========================
    // åŒ¯å‡º/åŒ¯å…¥åŠŸèƒ½
    // =========================
    function exportToCSV(type) {
      let csvContent = '', filename = '';
      
      if (type==='transactions') {
        csvContent = 'Date,Market,Symbol,Name,Type,Quantity,Price,OddLot,Fee,Tax,Total Amount,Note\n';
        transactions.forEach(t=>{
          csvContent += `${t.date},${t.market},${t.symbol},"${t.name}",${t.type},${t.quantity},${t.price},${t.isOddLot?'Yes':'No'},${t.fee},${t.tax},${t.totalAmount},"${t.note||''}"\n`;
        });
        filename='stock_transactions.csv';
      } else if (type==='exchange') {
        csvContent = 'Date,Exchange Type,From Amount,Rate,To Amount,Fee,Bank,Note\n';
        exchanges.forEach(e=>{
          csvContent += `${e.date},${e.type},${e.fromAmount},${e.rate},${e.toAmount},${e.fee},"${e.bank||''}","${e.note||''}"\n`;
        });
        filename='exchange_records.csv';
      } else if (type==='capital') {
        csvContent = 'Date,Type,Amount,Note\n';
        capitalRecords.forEach(c=>{
          csvContent += `${c.date},${c.type},${c.amount},"${c.note||''}"\n`;
        });
        filename='capital_records.csv';
      }
      
      downloadCSV(csvContent, filename);
    }
    
    function downloadCSV(csvContent, filename) {
      const blob = new Blob(['\ufeff'+csvContent], { type:'text/csv;charset=utf-8;' });
      const link = document.createElement('a'); 
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url); 
      link.setAttribute('download', filename);
      link.style.visibility='hidden'; 
      document.body.appendChild(link); 
      link.click(); 
      document.body.removeChild(link);
    }
    
    function exportAllData() {
      flushWorkingSetsToAccount();
      const data = { 
        accounts, 
        selectedAccountId: currentAccountId, 
        appSettings,
        exportDate: new Date().toISOString(),
        version: '2.1.0'
      };
      const dataStr = JSON.stringify(data, null, 2);
      const blob = new Blob([dataStr], { type:'application/json' });
      const url = URL.createObjectURL(blob); 
      const link = document.createElement('a');
      link.href = url; 
      link.download = `portfolio_backup_${new Date().toISOString().split('T')[0]}.json`; 
      link.click();
      showNotification('å‚™ä»½æª”æ¡ˆå·²ä¸‹è¼‰','success');
    }

    function importData(input) {
      const file = input.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);
          
          if (data.accounts) {
            // æ–°ç‰ˆæ ¼å¼
            if (!confirm('ç¢ºå®šè¦åŒ¯å…¥å‚™ä»½è³‡æ–™å—ï¼Ÿé€™å°‡è¦†è“‹ç¾æœ‰è³‡æ–™ï¼')) return;
            
            accounts = data.accounts;
            currentAccountId = data.selectedAccountId || Object.keys(accounts)[0];
            
            if (data.appSettings) {
              appSettings = {...appSettings, ...data.appSettings};
              localStorage.setItem('appSettings', JSON.stringify(appSettings));
            }
            
            saveLocalData();
            refreshAccountSelect();
            hydrateFromAccount();
            loadAppSettingsUI();
            
            showNotification(`æˆåŠŸåŒ¯å…¥ ${Object.keys(accounts).length} å€‹å¸³æˆ¶çš„è³‡æ–™ï¼`, 'success');
          } else {
            // èˆŠç‰ˆæ ¼å¼
            if (!confirm('æª¢æ¸¬åˆ°èˆŠç‰ˆæ ¼å¼ï¼Œå°‡è½‰æ›ç‚ºæ–°çš„å¸³æˆ¶åˆ¶åº¦ã€‚ç¢ºå®šåŒ¯å…¥å—ï¼Ÿ')) return;
            
            const acc = createEmptyAccount('åŒ¯å…¥å¸³æˆ¶', 'ç¾è‚¡', 'TWD');
            acc.transactions = data.transactions || [];
            acc.exchanges = data.exchanges || [];
            acc.capitalRecords = data.capitalRecords || [];
            acc.feeSettings = data.feeSettings || feeSettings;
            
            accounts[acc.id] = acc;
            currentAccountId = acc.id;
            
            saveLocalData();
            refreshAccountSelect();
            hydrateFromAccount();
            
            showNotification('èˆŠç‰ˆè³‡æ–™å·²æˆåŠŸè½‰æ›ä¸¦åŒ¯å…¥ï¼', 'success');
          }
          
        } catch (e) {
          showNotification('åŒ¯å…¥å¤±æ•—ï¼šæª”æ¡ˆæ ¼å¼éŒ¯èª¤', 'error');
        }
      };
      reader.readAsText(file);
      
      // æ¸…ç©º input
      input.value = '';
    }
    
    function clearAllData() {
      if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰è³‡æ–™å—ï¼Ÿæ­¤æ“ä½œç„¡æ³•å¾©åŸï¼')) return;
      if (!confirm('æœ€å¾Œç¢ºèªï¼šé€™å°‡åˆªé™¤æ‰€æœ‰å¸³æˆ¶ã€äº¤æ˜“è¨˜éŒ„å’Œè¨­å®šï¼')) return;
      
      transactions=[]; 
      exchanges=[]; 
      capitalRecords=[]; 
      currentPrices={};
      accounts={}; 
      currentAccountId=null;
      
      // å»ºç«‹æ–°çš„é è¨­å¸³æˆ¶
      const defaultAcc = createEmptyAccount('é è¨­å¸³æˆ¶', 'ç¾è‚¡', 'TWD');
      accounts[defaultAcc.id] = defaultAcc;
      currentAccountId = defaultAcc.id;
      
      saveLocalData();
      refreshAccountSelect();
      hydrateFromAccount();
      updateTransactionTable(); 
      updateExchangeTable(); 
      updatePortfolio(); 
      updateCapitalTable(); 
      updateAnalysis();
      
      showNotification('æ‰€æœ‰è³‡æ–™å·²æ¸…ç©ºä¸¦é‡æ–°åˆå§‹åŒ–ï¼','success');
    }

    // =========================
    // äº‹ä»¶ç¶å®š
    // =========================
    const debounce = (fn, t=350) => { 
      let id; 
      return (...args)=>{ 
        clearTimeout(id); 
        id=setTimeout(()=>fn(...args), t); 
      }; 
    };
    const debouncedPeekQuote = debounce(peekQuote, 450);

    // è¡¨å–®äº‹ä»¶ç¶å®š
    function bindFormEvents() {
      document.getElementById('fromAmount').addEventListener('input', calculateExchangeAmount);
      document.getElementById('exchangeRate').addEventListener('input', calculateExchangeAmount);
      
      ['market','quantity','price','type','oddLot'].forEach(id=>{
        const el = document.getElementById(id);
        if (el) {
          el.addEventListener('change', calculateFees);
          el.addEventListener('input', calculateFees);
        }
      });
      
      const symbolEl = document.getElementById('symbol');
      if (symbolEl) {
        symbolEl.addEventListener('input', debouncedPeekQuote);
      }
      
      const marketEl = document.getElementById('market');
      if (marketEl) {
        marketEl.addEventListener('change', function(){
          const market = this.value;
          const oddLotGroup = document.getElementById('oddLot').parentElement;
          if (market==='TW') { 
            oddLotGroup.style.display='flex'; 
          } else { 
            oddLotGroup.style.display='none'; 
            document.getElementById('oddLot').value='false'; 
          }
          calculateFees(); 
          debouncedPeekQuote();
        });
      }
    }

    // =========================
    // åˆå§‹åŒ–
    // =========================
    window.addEventListener('load', function(){
      // åˆå§‹åŒ– Firebase
      FB.init();
      
      // è¨­å®šèªè­‰ç‹€æ…‹ç›£è½
      if (FB.ready) {
        try {
          FB.onAuth((user)=>{
            const signedIn = !!user;
            const btn = document.getElementById('syncBtn');
            if (btn) btn.disabled = !signedIn;
            updateSyncStatus(signedIn ? 'ç™»å…¥ç‹€æ…‹ï¼šç·šä¸Š' : 'é›¢ç·šæ¨¡å¼', signedIn);
            if (signedIn) loadUserData();
          });
        } catch(e){
          console.warn('Firebaseèªè­‰ç›£è½è¨­å®šå¤±æ•—:', e);
        }
      }
      
      // è¼‰å…¥æœ¬åœ°è³‡æ–™
      loadLocalData();
      
      // è¨­å®šé è¨­æ—¥æœŸ
      setDefaultDates();
      
      // ç¶å®šè¡¨å–®äº‹ä»¶
      bindFormEvents();
      
      // åˆå§‹åŒ–åˆ†æ
      updateAnalysis();
      
      // è¼‰å…¥è¨­å®šUI
      loadAppSettingsUI();
      
      // å¦‚æœå·²æœ‰å¸‚å ´å’Œä»£è™Ÿï¼ŒåŸ·è¡ŒæŸ¥åƒ¹
      setTimeout(debouncedPeekQuote, 100);
      
      console.log('è‚¡ç¥¨æŠ•è³‡çµ„åˆç®¡ç†ç³»çµ±å·²å®Œæˆåˆå§‹åŒ–');
    });
  </script>
</body>
</html>
